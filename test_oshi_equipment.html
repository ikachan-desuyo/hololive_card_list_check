<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>推しホロメン装備テスト</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .test-button {
            padding: 10px 15px;
            margin: 5px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .test-button:hover {
            background-color: #0056b3;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 3px;
        }
        .pass {
            background-color: #d4edda;
            color: #155724;
        }
        .fail {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <h1>推しホロメン装備テスト</h1>
    
    <div class="test-section">
        <h2>テスト1: ドロップターゲット機能の確認</h2>
        <button class="test-button" onclick="testDropTargets()">ドロップターゲット機能をテスト</button>
        <div id="dropTargetResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>テスト2: ハイライト機能の確認</h2>
        <button class="test-button" onclick="testHighlights()">ハイライト機能をテスト</button>
        <div id="highlightResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>テスト3: 装備表示機能の確認</h2>
        <button class="test-button" onclick="testEquipmentDisplay()">装備表示機能をテスト</button>
        <div id="equipmentDisplayResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>テスト結果ログ</h2>
        <div id="testLog" style="background-color: #f1f1f1; padding: 10px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;"></div>
    </div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[テスト] ${message}`);
        }

        function testDropTargets() {
            log('ドロップターゲット機能テスト開始');
            
            // Battle Simulatorが読み込まれているかチェック
            if (typeof window.battleEngine === 'undefined') {
                document.getElementById('dropTargetResult').innerHTML = 
                    '<span class="fail">❌ Battle Engineが読み込まれていません。battle_simulator.htmlから実行してください。</span>';
                log('Battle Engineが見つかりません');
                return;
            }
            
            // CardDisplayManagerが存在するかチェック
            if (!window.battleEngine.cardDisplayManager) {
                document.getElementById('dropTargetResult').innerHTML = 
                    '<span class="fail">❌ CardDisplayManagerが見つかりません。</span>';
                log('CardDisplayManagerが見つかりません');
                return;
            }
            
            // 推しホロメン要素を探す
            const oshiElements = document.querySelectorAll('.battle-player .oshi .card');
            const fieldElements = document.querySelectorAll('.battle-player .center .card, .battle-player .collab .card, .battle-player .back-slot .card');
            
            log(`推しホロメン要素: ${oshiElements.length}個`);
            log(`フィールドホロメン要素: ${fieldElements.length}個`);
            
            let result = '';
            
            // 推しホロメンにドロップイベントハンドラーがあるかチェック
            let oshiHasDropHandler = false;
            oshiElements.forEach((element, index) => {
                const events = getEventListeners ? getEventListeners(element) : null;
                if (events && (events.dragover || events.drop)) {
                    oshiHasDropHandler = true;
                    log(`推しホロメン${index + 1}にドロップハンドラーが設定されています`);
                }
            });
            
            if (oshiHasDropHandler) {
                result += '<span class="fail">❌ 推しホロメンにドロップハンドラーが設定されています（装備可能状態）</span><br>';
            } else {
                result += '<span class="pass">✅ 推しホロメンにドロップハンドラーが設定されていません（装備不可状態）</span><br>';
            }
            
            // フィールドホロメンにドロップイベントハンドラーがあるかチェック
            let fieldHasDropHandler = false;
            fieldElements.forEach((element, index) => {
                const events = getEventListeners ? getEventListeners(element) : null;
                if (events && (events.dragover || events.drop)) {
                    fieldHasDropHandler = true;
                    log(`フィールドホロメン${index + 1}にドロップハンドラーが設定されています`);
                }
            });
            
            if (fieldHasDropHandler) {
                result += '<span class="pass">✅ フィールドホロメンにドロップハンドラーが設定されています（装備可能状態）</span>';
            } else {
                result += '<span class="fail">❌ フィールドホロメンにドロップハンドラーが設定されていません</span>';
            }
            
            document.getElementById('dropTargetResult').innerHTML = result;
            log('ドロップターゲット機能テスト完了');
        }

        function testHighlights() {
            log('ハイライト機能テスト開始');
            
            if (typeof window.battleEngine === 'undefined' || !window.battleEngine.cardDisplayManager) {
                document.getElementById('highlightResult').innerHTML = 
                    '<span class="fail">❌ Battle EngineまたはCardDisplayManagerが見つかりません。</span>';
                return;
            }
            
            // ハイライト機能をテスト
            try {
                window.battleEngine.cardDisplayManager.highlightEquipmentTargets();
                
                // ハイライトされた要素をチェック
                const highlightedElements = document.querySelectorAll('.equipment-potential-target');
                const oshiHighlighted = document.querySelectorAll('.oshi .equipment-potential-target');
                const fieldHighlighted = document.querySelectorAll('.center .equipment-potential-target, .collab .equipment-potential-target, .back-slot .equipment-potential-target');
                
                log(`ハイライトされた要素総数: ${highlightedElements.length}`);
                log(`推しホロメンハイライト: ${oshiHighlighted.length}`);
                log(`フィールドホロメンハイライト: ${fieldHighlighted.length}`);
                
                let result = '';
                
                if (oshiHighlighted.length === 0) {
                    result += '<span class="pass">✅ 推しホロメンはハイライトされていません（正しい動作）</span><br>';
                } else {
                    result += '<span class="fail">❌ 推しホロメンがハイライトされています（間違った動作）</span><br>';
                }
                
                if (fieldHighlighted.length > 0) {
                    result += '<span class="pass">✅ フィールドホロメンがハイライトされています（正しい動作）</span>';
                } else {
                    result += '<span class="fail">❌ フィールドホロメンがハイライトされていません</span>';
                }
                
                document.getElementById('highlightResult').innerHTML = result;
                
                // ハイライトをクリア
                setTimeout(() => {
                    window.battleEngine.cardDisplayManager.clearEquipmentTargetHighlight();
                    log('ハイライトをクリアしました');
                }, 2000);
                
            } catch (error) {
                document.getElementById('highlightResult').innerHTML = 
                    `<span class="fail">❌ ハイライトテスト中にエラー: ${error.message}</span>`;
                log(`ハイライトテストエラー: ${error.message}`);
            }
            
            log('ハイライト機能テスト完了');
        }

        function testEquipmentDisplay() {
            log('装備表示機能テスト開始');
            
            // 装備表示の条件をチェック
            const testCard = {
                name: 'テストホロメン',
                card_type: 'ホロメン',
                equipment: {
                    fans: [{ card: { name: 'テストファン' }, category: 'fans' }]
                }
            };
            
            let result = '';
            
            // 推しホロメンエリアでの装備表示テスト
            const oshiAreaIncluded = ['center', 'collab', 'backs', 'back1', 'back2', 'back3', 'back4', 'back5'].includes('oshi');
            
            if (oshiAreaIncluded) {
                result += '<span class="fail">❌ 推しホロメンエリア(oshi)が装備表示対象に含まれています</span><br>';
                log('推しホロメンが装備表示対象に含まれています');
            } else {
                result += '<span class="pass">✅ 推しホロメンエリア(oshi)は装備表示対象から除外されています</span><br>';
                log('推しホロメンは装備表示対象から除外されています');
            }
            
            // フィールドエリアでの装備表示テスト
            const fieldAreasIncluded = ['center', 'collab', 'back1'].every(area => 
                ['center', 'collab', 'backs', 'back1', 'back2', 'back3', 'back4', 'back5'].includes(area)
            );
            
            if (fieldAreasIncluded) {
                result += '<span class="pass">✅ フィールドエリアは装備表示対象に含まれています</span>';
                log('フィールドエリアが装備表示対象に含まれています');
            } else {
                result += '<span class="fail">❌ フィールドエリアが装備表示対象から除外されています</span>';
                log('フィールドエリアが装備表示対象から除外されています');
            }
            
            document.getElementById('equipmentDisplayResult').innerHTML = result;
            log('装備表示機能テスト完了');
        }

        // ページ読み込み時の初期化
        window.addEventListener('load', () => {
            log('推しホロメン装備テストページが読み込まれました');
            log('各テストボタンをクリックして確認してください');
        });
    </script>
</body>
</html>
