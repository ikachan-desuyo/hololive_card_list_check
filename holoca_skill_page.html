<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>カード詳細検索ページ</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      font-size: 15px;
      transition: background 0.3s, color 0.3s;
      overflow-x: hidden;
    }
    .container {
      max-width: none;
      width: fit-content;
      margin: 0 auto;
      padding: 10px;
    }
    .top-bar {
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 100;
      border-bottom: 1px solid #ccc;
      padding: 10px;
    }
    .top-bar .nav-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    .top-bar button {
      padding: 6px 10px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 6px;
    }
    h2 {
      text-align: center;
      margin-top: 10px;
      margin-bottom: 10px;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }
    .filter-group {
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 10px;
    }
    .filter-group legend {
      font-weight: bold;
      padding: 0 6px;
    }
    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
    }
    .filter-row label {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      table-layout: auto;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      font-size: 14px;
      text-align: left;
      vertical-align: top;
    }
    td:nth-child(2), th:nth-child(2) {
      white-space: nowrap;
      min-width: 100px;
    }
    td:nth-child(8), th:nth-child(8),
    td:nth-child(9), th:nth-child(9) {
      word-break: break-word;
      min-width: 120px;
    }
    input[type="number"] {
      width: 40px;
      background-color: #fff !important;
      color: #000;
      border: 1px solid #ccc;
    }
    img {
      width: 60px;
      border-radius: 4px;
      cursor: zoom-in;
      background-color: #fff;
      border: 1px solid #ddd;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="top-bar">
      <div class="nav-row">
        <button onclick="history.back()">← 前のページへ</button>
        <h2>カード詳細検索</h2>
        <div>
          <button onclick="toggleDarkMode()">🌗 モード切替</button>
          <input type="text" id="keywordSearch" placeholder="すべての項目から検索..." oninput="renderTable()" />
          <button onclick="toggleFilters()">🔽 フィルター表示／非表示</button>
        </div>
      </div>
      <div id="filtersWrapper">
        <fieldset class="filter-group">
          <legend>所持状態</legend>
          <div class="filter-row">
            <label><input type="checkbox" name="ownedState" value="owned" checked onchange="renderTable()"> 所持あり</label>
            <label><input type="checkbox" name="ownedState" value="unowned" checked onchange="renderTable()"> 所持なし</label>
          </div>
        </fieldset>

        <fieldset class="filter-group">
          <legend>レアリティ</legend>
          <button onclick="selectAll('rarityFilter')">全選択</button>
          <button onclick="clearAll('rarityFilter')">選択解除</button>
          <div class="filter-row" id="rarityFilter"></div>
        </fieldset>

        <fieldset class="filter-group">
          <legend>色</legend>
          <button onclick="selectAll('colorFilter')">全選択</button>
          <button onclick="clearAll('colorFilter')">選択解除</button>
          <div class="filter-row" id="colorFilter"></div>
        </fieldset>

        <fieldset class="filter-group">
          <legend>Bloom</legend>
          <button onclick="selectAll('bloomFilter')">全選択</button>
          <button onclick="clearAll('bloomFilter')">選択解除</button>
          <div class="filter-row" id="bloomFilter"></div>
        </fieldset>

        <fieldset class="filter-group">
          <legend>収録商品</legend>
          <select id="productFilter" onchange="renderTable()">
            <option value="">収録商品（選択）</option>
          </select>
        </fieldset>
      </div>
    </div>

    <table id="cardTable">
      <thead>
        <tr>
          <th>画像</th>
          <th>名前</th>
          <th>番号</th>
          <th>レア</th>
          <th>色</th>
          <th>Bloom</th>
          <th>HP</th>
          <th>tags</th>
          <th>skills</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="imageModal" onclick="hideImageModal()" style="
      display:none;
      position:fixed;
      top:0; left:0;
      width:100vw; height:100vh;
      background:rgba(0,0,0,0.8);
      text-align:center;
      z-index:1000;
      cursor:zoom-out;">
      <img src="" style="margin-top:5vh; width:100vw; max-height:90vh; object-fit:contain;">
    </div>

    <script>
      let cards = [];

      function toggleFilters() {
        const el = document.getElementById("filtersWrapper");
        el.style.display = el.style.display === "none" ? "block" : "none";
      }

      function toggleDarkMode() {
        document.body.classList.toggle("dark");
        localStorage.setItem("darkMode", document.body.classList.contains("dark"));
      }

      function selectAll(id) {
        document.querySelectorAll(`#${id} input[type="checkbox"]`).forEach(cb => cb.checked = true);
        renderTable();
      }

      function clearAll(id) {
        document.querySelectorAll(`#${id} input[type="checkbox"]`).forEach(cb => cb.checked = false);
        renderTable();
      }

      function setupFilters() {
        const raritySet = new Set(), colorSet = new Set(), bloomSet = new Set(), productSet = new Set();
        cards.forEach(c => {
          raritySet.add(c.rarity);
          colorSet.add(c.color);
          bloomSet.add(c.bloom);
          productSet.add(c.product);
        });

        function populateCheck(id, items) {
          const container = document.getElementById(id);
          items.forEach(val => {
            const label = document.createElement("label");
            label.innerHTML = `<input type="checkbox" value="${val}" checked onchange="renderTable()"> ${val}`;
            container.appendChild(label);
          });
        }

        function populateSelect(id, items, label) {
          const select = document.getElementById(id);
          select.innerHTML = `<option value="">${label}</option>`;
          [...items].sort().forEach(val => {
            const opt = document.createElement("option");
            opt.value = val;
            opt.textContent = val;
            select.appendChild(opt);
          });
        }

        populateCheck("rarityFilter", [...raritySet].sort());
        populateCheck("colorFilter", [...colorSet].sort());
        populateCheck("bloomFilter", [...bloomSet].sort());
        populateSelect("productFilter", productSet, "収録商品");
      }

      function renderSkills(skills) {
        return skills.map(skill => {
          if (skill.text) {
            return `<b>【${skill.type}】</b><br>${skill.text}`;
          } else {
            const namePart = skill.name ? `[${skill.name}]` : "";
            const typePart = `<b>【${skill.type}】</b>`;
            const subtype = skill.subtype ? `<br>${skill.subtype}` : "";
            const dmg = skill.dmg ? `（${skill.dmg}）` : "";
            const iconText = skill.icons?.main ? skill.icons.main.join("・") : "";
            const tokkouText = skill.icons?.tokkou ? `特攻：${skill.icons.tokkou.join("・")}` : "";
            const icons = iconText || tokkouText ? `<br>${iconText}${tokkouText ? "｜" + tokkouText : ""}` : "";
            const desc = skill.description ?? "";
            return `${typePart}${namePart}${dmg}${subtype}${icons}<br>${desc}`;
          }
        }).join("<br><br>");
      }

      function renderTable() {
        const keyword = document.getElementById("keywordSearch").value.toLowerCase();
        const getChecked = id => [...document.querySelectorAll(`#${id} input:checked`)].map(el => el.value);
        const ownedStates = [...document.querySelectorAll('input[name="ownedState"]:checked')].map(el => el.value);
        const rarity = getChecked("rarityFilter");
        const color = getChecked("colorFilter");
        const bloom = getChecked("bloomFilter");
        const product = document.getElementById("productFilter").value.toLowerCase();

        const tbody = document.querySelector("#cardTable tbody");
        tbody.innerHTML = "";

        cards.forEach(card => {
          const count = card.owned;

          const matchOwned =
            ownedStates.length === 0 ||
            (ownedStates.includes("owned") && count > 0) ||
            (ownedStates.includes("unowned") && (!count || count == 0));
          if (!matchOwned) return;

          const allText = [
            card.name, card.id, card.rarity, card.color, card.bloom,
            card.hp ?? card.life ?? "", card.product,
            card.tags.join(" "), renderSkills(card.skills).replace(/<br>/g, " ")
          ].join(" ").toLowerCase();

          const match = {
            rarity: rarity.length === 0 || rarity.includes(card.rarity),
            color: color.length === 0 || color.includes(card.color),
            bloom: bloom.length === 0 || bloom.includes(card.bloom),
            product: !product || card.product.toLowerCase().includes(product),
            keyword: !keyword || allText.includes(keyword)
          };

          if (Object.values(match).includes(false)) return;

          const row = document.createElement("tr");
          row.innerHTML = `
            <td><img src="${card.image}" alt="${card.name}" onclick="showImageModal('${card.image}')"></td>
            <td>${card.name}</td>
            <td>${card.id}</td>
            <td>${card.rarity}</td>
            <td>${card.color}</td>
            <td>${card.bloom}</td>
            <td>${card.hp ?? card.life ?? "-"}</td>
            <td>${card.tags.join("<br>")}</td>
            <td>${renderSkills(card.skills)}</td>
          `;
          tbody.appendChild(row);
        });
      }

      function showImageModal(src) {
        const modal = document.getElementById("imageModal");
        modal.querySelector("img").src = src;
        modal.style.display = "block";
      }

      function hideImageModal() {
        document.getElementById("imageModal").style.display = "none";
      }

      window.onload = () => {
        if (localStorage.getItem("darkMode") === "true") {
          document.body.classList.add("dark");
        }

        fetch("json_file/card_data.json")
          .then(response => response.json())
          .then(rawData => {
            cards = Object.entries(rawData).map(([key, card]) => ({
              id: key,
              name: card.name,
              rarity: card.rarity ?? "-",
              color: card.color ?? "-",
              bloom: card.bloom_level ?? "-",
              hp: card.hp ?? null,
              life: card.life ?? null,
              product: card.product ?? "-",
              tags: card.tags ?? [],
              skills: card.skills ?? [],
              image: card.image_url,
              owned: parseInt(localStorage.getItem("count_" + key) ?? "0")
            }));
            setupFilters();
            renderTable();
          })
          .catch(() => alert("JSONファイルの読み込みに失敗しました"));
      };
    </script>
  </div>
</body>
</html>
