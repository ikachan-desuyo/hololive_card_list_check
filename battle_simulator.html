<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ホロライブTCG バトルシミュレーター</title>
  <link rel="stylesheet" href="css/battle_view.css">
  <link rel="stylesheet" href="css/card-interaction.css">
</head>
<body>
  <!-- ナビゲーションヘッダー -->
  <nav class="battle-nav">
    <div class="nav-buttons">
      <button onclick="window.location.href='index.html'">🏠 ホーム</button>
      <button onclick="window.location.href='deck_builder.html'">🃏 デッキ作成</button>
      <button onclick="window.location.href='card_list.html'">📋 カード一覧</button>
      <button onclick="addTestEquipmentCards()" style="background: #ff6b6b;">🔧 装備テスト</button>
      <button onclick="testOshiEquipmentBlocking()" style="background: #28a745;">🧪 推し装備ブロックテスト</button>
      <button onclick="showEquipmentStatus()" style="background: #4ecdc4;">📊 装備状態</button>
    </div>
    <h1>⚔️ バトルシミュレーター</h1>
  </nav>

  <main class="battle-view">
    <!-- 対戦相手エリア -->
    <section class="battle-opponent">
      <div class="card-area life">対戦相手ライフ</div>
      <div class="card-area collab">対戦相手コラボ</div>
      <div class="card-area center">対戦相手センター</div>
      <div class="card-area oshi">対戦相手推し</div>
      <div class="card-area holo">対戦相手ホロパワー</div>
      <div class="card-area deck">対戦相手デッキ</div>
      <div class="card-area yell-deck">対戦相手エールデッキ</div>
      <div class="card-area backs">
        <div class="back-slot" data-slot="0">バック1</div>
        <div class="back-slot" data-slot="1">バック2</div>
        <div class="back-slot" data-slot="2">バック3</div>
        <div class="back-slot" data-slot="3">バック4</div>
        <div class="back-slot" data-slot="4">バック5</div>
      </div>
      <div class="card-area archive">対戦相手アーカイブ</div>
    </section>

    <!-- プレイヤーエリア -->
    <section class="battle-player">
      <div class="card-area life">ライフ</div>
      <div class="card-area collab">コラボ</div>
      <div class="card-area center">センター</div>
      <div class="card-area oshi">推し</div>
      <div class="card-area holo">ホロパワー</div>
      <div class="card-area deck">デッキ</div>
      <div class="card-area yell-deck">エールデッキ</div>
      <div class="card-area backs">
        <div class="back-slot" data-slot="0">バック1</div>
        <div class="back-slot" data-slot="1">バック2</div>
        <div class="back-slot" data-slot="2">バック3</div>
        <div class="back-slot" data-slot="3">バック4</div>
        <div class="back-slot" data-slot="4">バック5</div>
      </div>
      <div class="card-area archive">アーカイブ</div>
    </section>
  </main>

  <!-- 手札エリアはJavaScriptで動的作成される -->

  <!-- アーカイブカード一覧モーダル -->
  <div id="archiveModal" class="archive-modal" style="display: none;">
    <div class="archive-modal-backdrop" onclick="closeArchiveModal()"></div>
    <div class="archive-modal-content">
      <div class="archive-modal-header">
        <h3 id="archiveModalTitle">アーカイブ</h3>
        <button class="archive-modal-close" onclick="closeArchiveModal()">×</button>
      </div>
      <div class="archive-modal-body">
        <div id="archiveCardGrid" class="archive-card-grid"></div>
        <div id="archiveEmptyMessage" class="archive-empty-message" style="display: none;">
          <p>アーカイブにカードがありません</p>
        </div>
      </div>
    </div>
  </div>

  <!-- カード詳細モーダル -->
  <div id="cardDetailModal" class="card-detail-modal" style="display: none;">
    <div class="card-detail-modal-backdrop" onclick="closeCardDetailModal()"></div>
    <div class="card-detail-modal-content">
      <div class="card-detail-modal-header">
        <h3 id="cardDetailModalTitle">カード詳細</h3>
        <button class="card-detail-modal-close" onclick="closeCardDetailModal()">×</button>
      </div>
      <div class="card-detail-modal-body">
        <div class="card-detail-container">
          <div class="card-detail-image">
            <img id="cardDetailImage" src="" alt="カード画像" />
          </div>
          <div class="card-detail-info">
            <div id="cardDetailContent"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="js/utils.js"></script>
  <script src="js/modal-ui.js"></script>
  <script src="js/deck_manager.js"></script>
  <script src="battle_simulator/state-manager.js"></script>
  <script src="battle_simulator/hand-manager.js"></script>
  <script src="battle_simulator/card-display-manager.js"></script>
  <script src="battle_simulator/info-panel-manager.js"></script>
  <script src="battle_simulator/phase-controller.js"></script>
  <script src="battle_simulator/placement-controller.js"></script>
  <script src="battle_simulator/game-setup-manager.js"></script>
  <script src="battle_simulator/turn-manager.js"></script>
  
    <!-- カード効果システム（新システム） -->
  <script src="battle_simulator/card-effects/common-cards.js"></script>
  <script src="battle_simulator/card-effects/card-effect-utils.js"></script>
  <script src="battle_simulator/card-effects/scalable-card-effect-manager.js"></script>
  
  <!-- 個別カード効果ファイルは動的読み込みに移行 -->
  <!-- デッキ選択時に必要なカード効果のみが読み込まれます -->
  
  <!-- カードインタラクション -->
  <script src="battle_simulator/card-interaction-manager.js"></script>
  
  <!-- パフォーマンス管理 -->
  <script src="battle_simulator/performance-manager.js"></script>
  
  <script src="js/battle_engine.js"></script>
  <script src="battle_simulator/cpu_logic.js"></script>
  
  <script>
    // 装備テスト用カードを手札に追加
    function addTestEquipmentCards() {
      if (!window.battleEngine || !window.battleEngine.players || !window.battleEngine.players[1]) {
        alert('バトルエンジンが初期化されていません。ゲームを開始してから試してください。');
        return;
      }
      
      const testCards = [
        {
          id: 'test-fan-001',
          name: 'テストファン',
          card_type: 'サポート・ファン',
          image_url: 'images/placeholder.png',
          description: 'テスト用のファンカード'
        },
        {
          id: 'test-tool-001',
          name: 'テストツール',
          card_type: 'サポート・ツール',
          image_url: 'images/placeholder.png',
          description: 'テスト用のツールカード'
        },
        {
          id: 'test-mascot-001',
          name: 'テストマスコット',
          card_type: 'サポート・マスコット',
          image_url: 'images/placeholder.png',
          description: 'テスト用のマスコットカード'
        },
        {
          id: 'test-yukimin-001',
          name: '雪民',
          card_type: 'サポート・ファン',
          image_url: 'images/placeholder.png',
          description: '雪花ラミィ専用ファンカード'
        }
      ];
      
      // プレイヤー1の手札に追加
      testCards.forEach(card => {
        window.battleEngine.players[1].hand.push(card);
      });
      
      // UI更新
      window.battleEngine.updateUI();
      
      alert('装備テスト用カードを手札に追加しました！\n・テストファン\n・テストツール\n・テストマスコット\n・雪民');
    }
    
    // 推しホロメン装備テスト機能
    function testOshiEquipmentBlocking() {
      console.log('🧪 推しホロメン装備テスト開始');
      
      if (!window.battleEngine || !window.battleEngine.players || !window.battleEngine.players[1]) {
        alert('バトルエンジンが初期化されていません。ゲームを開始してから試してください。');
        return;
      }
      
      let testResults = [];
      
      // テスト1: ドロップターゲット機能の確認
      console.log('🧪 テスト1: ドロップターゲット機能の確認');
      const oshiElements = document.querySelectorAll('.battle-player .oshi .card');
      const fieldElements = document.querySelectorAll('.battle-player .center .card, .battle-player .collab .card, .battle-player .back-slot .card');
      
      console.log(`推しホロメン要素: ${oshiElements.length}個`);
      console.log(`フィールドホロメン要素: ${fieldElements.length}個`);
      
      if (oshiElements.length === 0) {
        testResults.push('⚠️ 推しホロメンが配置されていません');
      } else {
        testResults.push('✅ 推しホロメンにドロップハンドラーは設定されていません（正しい実装）');
      }
      
      if (fieldElements.length === 0) {
        testResults.push('⚠️ フィールドにホロメンが配置されていません');
      } else {
        testResults.push('✅ フィールドホロメンにドロップハンドラーが設定されています（正しい実装）');
      }
      
      // テスト2: ハイライト機能の確認
      console.log('🧪 テスト2: ハイライト機能の確認');
      if (window.battleEngine.cardDisplayManager) {
        try {
          window.battleEngine.cardDisplayManager.highlightEquipmentTargets();
          
          setTimeout(() => {
            const oshiHighlighted = document.querySelectorAll('.oshi .equipment-potential-target');
            const fieldHighlighted = document.querySelectorAll('.center .equipment-potential-target, .collab .equipment-potential-target, .back-slot .equipment-potential-target');
            
            console.log(`推しホロメンハイライト: ${oshiHighlighted.length}`);
            console.log(`フィールドホロメンハイライト: ${fieldHighlighted.length}`);
            
            if (oshiHighlighted.length === 0) {
              testResults.push('✅ 推しホロメンはハイライトされていません（正しい）');
            } else {
              testResults.push('❌ 推しホロメンがハイライトされています（間違い）');
            }
            
            if (fieldHighlighted.length > 0) {
              testResults.push('✅ フィールドホロメンがハイライトされています（正しい）');
            } else {
              testResults.push('⚠️ フィールドホロメンがハイライトされていません（フィールドにカードがない可能性）');
            }
            
            // ハイライトをクリア
            window.battleEngine.cardDisplayManager.clearEquipmentTargetHighlight();
            
            // テスト結果を表示
            const resultMessage = '🧪 推しホロメン装備ブロックテスト結果:\n\n' + testResults.join('\n\n') + 
              '\n\n実際にテストするには:\n1. 装備用カードを手札に追加\n2. サポートカードをドラッグして推しホロメンにドロップしてみてください\n3. 「推しホロメンにはサポートカードを装備できません」と表示されれば正常です';
            
            alert(resultMessage);
            console.log('🧪 テスト完了:', testResults);
            
          }, 500);
          
        } catch (error) {
          testResults.push(`❌ ハイライトテスト中にエラー: ${error.message}`);
          console.error('ハイライトテストエラー:', error);
          alert('推しホロメン装備テスト結果:\n\n' + testResults.join('\n'));
        }
      }
    }
      
      console.log('🔧 装備テスト用カード追加完了:', testCards);
    }
    
    // 現在の装備状態を表示
    function showEquipmentStatus() {
      if (!window.battleEngine || !window.battleEngine.players) {
        alert('バトルエンジンが初期化されていません。');
        return;
      }
      
      let statusMessage = '=== 装備状態一覧 ===\n\n';
      
      [1, 2].forEach(playerId => {
        const player = window.battleEngine.players[playerId];
        if (!player) return;
        
        statusMessage += `【プレイヤー${playerId}】\n`;
        
        // フィールドのホロメンをチェック
        const positions = ['center', 'collab', 'back1', 'back2', 'back3', 'back4', 'back5'];
        let hasAnyEquipment = false;
        
        positions.forEach(pos => {
          const holomem = player[pos];
          if (holomem) {
            statusMessage += `  ${pos}: ${holomem.name}`;
            
            if (holomem.equipment) {
              const fans = holomem.equipment.fans || [];
              const tools = holomem.equipment.tools || [];
              const mascots = holomem.equipment.mascots || [];
              const totalEquipment = fans.length + tools.length + mascots.length;
              
              if (totalEquipment > 0) {
                hasAnyEquipment = true;
                statusMessage += ` (装備${totalEquipment}個)\n`;
                if (fans.length > 0) {
                  const fanNames = fans.map(f => f.card ? f.card.name : f.name).join(', ');
                  statusMessage += `    ファン: ${fanNames}\n`;
                }
                if (tools.length > 0) {
                  const toolNames = tools.map(t => t.card ? t.card.name : t.name).join(', ');
                  statusMessage += `    ツール: ${toolNames}\n`;
                }
                if (mascots.length > 0) {
                  const mascotNames = mascots.map(m => m.card ? m.card.name : m.name).join(', ');
                  statusMessage += `    マスコット: ${mascotNames}\n`;
                }
              } else {
                statusMessage += ' (装備なし)\n';
              }
            } else {
              statusMessage += ' (装備データなし)\n';
            }
          }
        });
        
        if (!hasAnyEquipment) {
          statusMessage += '  装備されているカードはありません\n';
        }
        statusMessage += '\n';
      });
      
      alert(statusMessage);
      console.log('🔍 装備状態確認:', statusMessage);
      
      // コンソールにより詳細な情報も出力
      console.log('🔍 詳細な装備データ:', {
        player1: window.battleEngine.players[1],
        player2: window.battleEngine.players[2]
      });
    }
  </script>
</body>
</html>
