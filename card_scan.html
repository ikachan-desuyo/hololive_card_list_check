<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>改善案切り替えプレビュー</title>
  <script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady();"></script>
  <style>
    canvas {
      border: 1px solid black;
      margin-top: 1em;
    }
    .button-group {
      margin-top: 1em;
    }
    .active {
      font-weight: bold;
      background-color: #d0f0c0;
    }
  </style>
</head>
<body>
  <h2>カード画像アップロード</h2>
  <input type="file" id="fileInput" accept="image/*">
  <div id="opencv-status">🔄 OpenCV初期化中...</div>

  <div class="button-group">
    <button id="btn1">改善案1</button>
    <button id="btn2">改善案2</button>
  </div>

  <canvas id="canvasOutput"></canvas>

  <script>
    let uploadedImage = null;
    let currentStrategy = "strategy1";

    function onOpenCvReady() {
      cv['onRuntimeInitialized'] = () => {
        document.getElementById("opencv-status").innerText = "✅ OpenCV初期化完了";
        document.getElementById("fileInput").addEventListener("change", handleImageUpload);
        document.getElementById("btn1").addEventListener("click", () => applyStrategy("strategy1"));
        document.getElementById("btn2").addEventListener("click", () => applyStrategy("strategy2"));
      };
    }

    function handleImageUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.getElementById('canvasOutput');
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);
          uploadedImage = canvas;
          applyStrategy(currentStrategy); // 初期改善案で即実行
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    function applyStrategy(strategy) {
      currentStrategy = strategy;
      document.getElementById("btn1").classList.toggle("active", strategy === "strategy1");
      document.getElementById("btn2").classList.toggle("active", strategy === "strategy2");

      if (!uploadedImage || typeof cv === "undefined") return;

      const src = cv.imread(uploadedImage);
      const dst = new cv.Mat();

      if (strategy === "strategy1") {
        // 改善案1：ぼかして角度取得
        const gray = new cv.Mat();
        cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);
        cv.GaussianBlur(gray, gray, new cv.Size(5,5), 0);
        cv.Canny(gray, dst, 75, 200);
        gray.delete();
      } else if (strategy === "strategy2") {
        // 改善案2：モルフォロジーでノイズ除去
        const gray = new cv.Mat();
        const morph = new cv.Mat();
        cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);
        let kernel = cv.getStructuringElement(cv.MORPH_RECT, new cv.Size(3,3));
        cv.morphologyEx(gray, morph, cv.MORPH_CLOSE, kernel);
        cv.Canny(morph, dst, 50, 150);
        gray.delete(); morph.delete(); kernel.delete();
      }

      cv.imshow('canvasOutput', dst);
      src.delete(); dst.delete();
    }
  </script>
</body>
</html>