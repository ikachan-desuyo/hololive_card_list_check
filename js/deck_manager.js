/**
 * „Éá„ÉÉ„Ç≠ÁÆ°ÁêÜ„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
 * „Éá„ÉÉ„Ç≠„Éì„É´„ÉÄ„Éº„Å®„Éê„Éà„É´„Ç∑„Éü„É•„É¨„Éº„Çø„Éº„ÅÆÈÄ£Êê∫Ê©üËÉΩ
 */

class DeckManager {
  constructor() {
    this.savedDecks = this.loadSavedDecks();
  }

  // ‰øùÂ≠ò„Åï„Çå„Åü„Éá„ÉÉ„Ç≠„ÇíË™≠„ÅøËæº„Åø
  loadSavedDecks() {
    try {
      const savedDecks = localStorage.getItem("deckData");
      return savedDecks ? JSON.parse(savedDecks) : {};
    } catch (error) {
      console.error("„Éá„ÉÉ„Ç≠„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó:", error);
      return {};
    }
  }

  // „Éá„ÉÉ„Ç≠„É™„Çπ„Éà„ÇíÂèñÂæó
  getDeckNames() {
    return Object.keys(this.savedDecks);
  }

  // ÁâπÂÆö„ÅÆ„Éá„ÉÉ„Ç≠„ÇíÂèñÂæó
  getDeck(deckName) {
    return this.savedDecks[deckName] || null;
  }

  // „Éá„ÉÉ„Ç≠„Çí„Ç´„Éº„Éâ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Å´Â§âÊèõ
  async convertDeckToCards(deckCardIds) {
    if (!window.battleEngine || !window.battleEngine.cardDatabase) {
      console.error("„Ç´„Éº„Éâ„Éá„Éº„Çø„Éô„Éº„Çπ„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì");
      return { holomen: [], support: [], yell: [], oshi: null };
    }

    const cardDatabase = window.battleEngine.cardDatabase;
    const deck = {
      holomen: [],
      support: [],
      yell: [],
      oshi: null
    };

    deckCardIds.forEach(cardId => {
      const card = cardDatabase[cardId];
      if (!card) {
        console.warn(`„Ç´„Éº„Éâ ${cardId} „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì`);
        return;
      }

      if (card.card_type === 'Êé®„Åó„Éõ„É≠„É°„É≥') {
        deck.oshi = card;
      } else if (card.card_type === '„Ç®„Éº„É´') {
        deck.yell.push(card);
      } else if (card.card_type === '„Éõ„É≠„É°„É≥') {
        deck.holomen.push(card);
      } else if (card.card_type.includes('„Çµ„Éù„Éº„Éà')) {
        deck.support.push(card);
      }
    });

    return deck;
  }

  // „Éá„ÉÉ„Ç≠„ÅÆÂ¶•ÂΩìÊÄß„ÉÅ„Çß„ÉÉ„ÇØ
  validateDeck(deck) {
    const errors = [];

    // Êé®„Åó„Éõ„É≠„É°„É≥„Åå1Êûö„Åß„ÅÇ„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç
    if (!deck.oshi) {
      errors.push("Êé®„Åó„Éõ„É≠„É°„É≥„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì");
    }

    // „É°„Ç§„É≥„Éá„ÉÉ„Ç≠ÊûöÊï∞„ÉÅ„Çß„ÉÉ„ÇØÔºà50ÊûöÔºâ
    const mainDeckSize = deck.holomen.length + deck.support.length;
    if (mainDeckSize !== 50) {
      errors.push(`„É°„Ç§„É≥„Éá„ÉÉ„Ç≠„ÅØ50Êûö„Åß„ÅÇ„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„ÅôÔºàÁèæÂú®: ${mainDeckSize}ÊûöÔºâ`);
    }

    // „Ç®„Éº„É´„Éá„ÉÉ„Ç≠ÊûöÊï∞„ÉÅ„Çß„ÉÉ„ÇØÔºà20ÊûöÔºâ
    if (deck.yell.length !== 20) {
      errors.push(`„Ç®„Éº„É´„Éá„ÉÉ„Ç≠„ÅØ20Êûö„Åß„ÅÇ„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„ÅôÔºàÁèæÂú®: ${deck.yell.length}ÊûöÔºâ`);
    }

    return {
      isValid: errors.length === 0,
      errors: errors
    };
  }

  // „Éá„ÉÉ„Ç≠Áµ±Ë®à„ÇíÂèñÂæó
  getDeckStats(deck) {
    const colorCount = {};
    const rarityCount = {};
    
    [...deck.holomen, ...deck.support].forEach(card => {
      // Ëâ≤„ÅÆÁµ±Ë®à
      if (card.color) {
        colorCount[card.color] = (colorCount[card.color] || 0) + 1;
      }
      
      // „É¨„Ç¢„É™„ÉÜ„Ç£„ÅÆÁµ±Ë®à
      if (card.rarity) {
        rarityCount[card.rarity] = (rarityCount[card.rarity] || 0) + 1;
      }
    });

    return {
      mainDeckSize: deck.holomen.length + deck.support.length,
      yellDeckSize: deck.yell.length,
      holomenCount: deck.holomen.length,
      supportCount: deck.support.length,
      colorDistribution: colorCount,
      rarityDistribution: rarityCount
    };
  }
}

/**
 * „Éá„ÉÉ„Ç≠ÈÅ∏ÊäûUI
 */
class DeckSelectionUI {
  constructor(battleEngine, playerId = 1) {
    this.battleEngine = battleEngine;
    this.playerId = playerId;
    this.deckManager = new DeckManager();
    this.selectedDeck = null;
  }

  // „Éá„ÉÉ„Ç≠ÈÅ∏Êäû„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
  showDeckSelectionModal() {
    const modal = this.createDeckSelectionModal();
    document.body.appendChild(modal);
    this.populateDeckList();
  }

  createDeckSelectionModal() {
    const playerName = this.playerId === 1 ? '„Éó„É¨„Ç§„É§„Éº' : 'Áõ∏Êâã';
    const modal = document.createElement('div');
    modal.id = 'deck-selection-modal';
    modal.className = 'deck-modal';
    modal.innerHTML = `
      <div class="deck-modal-content">
        <div class="deck-modal-header">
          <h2>üìö ${playerName}„Éá„ÉÉ„Ç≠ÈÅ∏Êäû</h2>
          <button class="deck-modal-close" onclick="this.closest('.deck-modal').remove()">√ó</button>
        </div>
        
        <div class="deck-modal-body">
          <div class="deck-list-container">
            <h3>‰øùÂ≠òÊ∏à„Åø„Éá„ÉÉ„Ç≠</h3>
            <div id="saved-deck-list" class="saved-deck-list">
              <!-- „Éá„ÉÉ„Ç≠„É™„Çπ„Éà„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
            </div>
          </div>
          
          <div class="deck-preview-container">
            <h3>„Éá„ÉÉ„Ç≠„Éó„É¨„Éì„É•„Éº</h3>
            <div id="deck-preview" class="deck-preview">
              <p>„Éá„ÉÉ„Ç≠„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
            </div>
            
            <div class="deck-actions">
              <button id="confirm-deck-selection" class="deck-button deck-button-primary" disabled>
                „Åì„ÅÆ„Éá„ÉÉ„Ç≠„Çí${playerName}Áî®„Å´‰ΩøÁî®
              </button>
              <button class="deck-button deck-button-secondary" onclick="window.open('deck_builder.html', '_blank')">
                Êñ∞„Åó„ÅÑ„Éá„ÉÉ„Ç≠„Çí‰ΩúÊàê
              </button>
            </div>
          </div>
        </div>
      </div>
    `;

    // CSS „Çπ„Çø„Ç§„É´„ÇíËøΩÂä†
    this.addModalStyles();

    // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
    modal.querySelector('#confirm-deck-selection').addEventListener('click', () => {
      this.confirmDeckSelection();
    });

    return modal;
  }

  addModalStyles() {
    if (document.getElementById('deck-modal-styles')) return;

    const style = document.createElement('style');
    style.id = 'deck-modal-styles';
    style.textContent = `
      .deck-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      }

      .deck-modal-content {
        background: white;
        border-radius: 15px;
        width: 90%;
        max-width: 900px;
        max-height: 80%;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      }

      .deck-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .deck-modal-header h2 {
        margin: 0;
        font-size: 1.5em;
      }

      .deck-modal-close {
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        padding: 5px 10px;
        border-radius: 50%;
        transition: background 0.3s;
      }

      .deck-modal-close:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .deck-modal-body {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        padding: 20px;
        max-height: 60vh;
        overflow-y: auto;
      }

      .saved-deck-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-height: 400px;
        overflow-y: auto;
      }

      .deck-item {
        padding: 15px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #f9f9f9;
      }

      .deck-item:hover {
        border-color: #667eea;
        background: #f0f0ff;
      }

      .deck-item.selected {
        border-color: #667eea;
        background: #e8ecff;
        box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
      }

      .deck-item-name {
        font-weight: bold;
        font-size: 1.1em;
        color: #333;
        margin-bottom: 5px;
      }

      .deck-item-stats {
        font-size: 0.9em;
        color: #666;
      }

      .deck-preview {
        background: #f9f9f9;
        border-radius: 10px;
        padding: 15px;
        min-height: 300px;
      }

      .deck-preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e0e0e0;
      }

      .deck-preview-name {
        font-size: 1.2em;
        font-weight: bold;
        color: #333;
      }

      .deck-preview-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 15px;
      }

      .deck-stat-item {
        background: white;
        padding: 8px 12px;
        border-radius: 8px;
        text-align: center;
        border: 1px solid #e0e0e0;
      }

      .deck-stat-label {
        font-size: 0.8em;
        color: #666;
      }

      .deck-stat-value {
        font-size: 1.1em;
        font-weight: bold;
        color: #333;
      }

      .deck-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }

      .deck-button {
        flex: 1;
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        font-size: 1em;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .deck-button-primary {
        background: #667eea;
        color: white;
      }

      .deck-button-primary:enabled:hover {
        background: #5a6fd8;
        transform: translateY(-1px);
      }

      .deck-button-primary:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .deck-button-secondary {
        background: #f0f0f0;
        color: #333;
        border: 1px solid #ccc;
      }

      .deck-button-secondary:hover {
        background: #e0e0e0;
      }

      @media (max-width: 768px) {
        .deck-modal-body {
          grid-template-columns: 1fr;
        }
      }
    `;

    document.head.appendChild(style);
  }

  populateDeckList() {
    const deckList = document.getElementById('saved-deck-list');
    const deckNames = this.deckManager.getDeckNames();

    if (deckNames.length === 0) {
      deckList.innerHTML = `
        <div style="text-align: center; padding: 20px; color: #666;">
          <p>‰øùÂ≠ò„Åï„Çå„Åü„Éá„ÉÉ„Ç≠„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
          <button class="deck-button deck-button-secondary" onclick="window.open('deck_builder.html', '_blank')">
            „Éá„ÉÉ„Ç≠„Çí‰ΩúÊàê„Åô„Çã
          </button>
        </div>
      `;
      return;
    }

    deckList.innerHTML = '';

    deckNames.forEach(deckName => {
      const deckCardIds = this.deckManager.getDeck(deckName);
      const deckItem = document.createElement('div');
      deckItem.className = 'deck-item';
      deckItem.innerHTML = `
        <div class="deck-item-name">${deckName}</div>
        <div class="deck-item-stats">„Ç´„Éº„ÉâÊï∞: ${deckCardIds.length}Êûö</div>
      `;

      deckItem.addEventListener('click', () => {
        this.selectDeck(deckName, deckItem);
      });

      deckList.appendChild(deckItem);
    });
  }

  async selectDeck(deckName, deckElement) {
    // Ââç„ÅÆÈÅ∏Êäû„ÇíËß£Èô§
    document.querySelectorAll('.deck-item.selected').forEach(item => {
      item.classList.remove('selected');
    });

    // Êñ∞„Åó„ÅÑÈÅ∏Êäû„Çí„Éû„Éº„ÇØ
    deckElement.classList.add('selected');
    this.selectedDeck = deckName;

    // „Éá„ÉÉ„Ç≠„Éó„É¨„Éì„É•„Éº„ÇíÊõ¥Êñ∞
    await this.updateDeckPreview(deckName);

    // Á¢∫Ë™ç„Éú„Çø„É≥„ÇíÊúâÂäπÂåñ
    document.getElementById('confirm-deck-selection').disabled = false;
  }

  async updateDeckPreview(deckName) {
    const previewContainer = document.getElementById('deck-preview');
    const deckCardIds = this.deckManager.getDeck(deckName);

    try {
      const deck = await this.deckManager.convertDeckToCards(deckCardIds);
      const stats = this.deckManager.getDeckStats(deck);
      const validation = this.deckManager.validateDeck(deck);

      previewContainer.innerHTML = `
        <div class="deck-preview-header">
          <div class="deck-preview-name">${deckName}</div>
          <div class="deck-validation ${validation.isValid ? 'valid' : 'invalid'}">
            ${validation.isValid ? '‚úÖ ÊúâÂäπ' : '‚ùå ÁÑ°Âäπ'}
          </div>
        </div>

        <div class="deck-preview-stats">
          <div class="deck-stat-item">
            <div class="deck-stat-label">„É°„Ç§„É≥„Éá„ÉÉ„Ç≠</div>
            <div class="deck-stat-value">${stats.mainDeckSize}Êûö</div>
          </div>
          <div class="deck-stat-item">
            <div class="deck-stat-label">„Ç®„Éº„É´„Éá„ÉÉ„Ç≠</div>
            <div class="deck-stat-value">${stats.yellDeckSize}Êûö</div>
          </div>
          <div class="deck-stat-item">
            <div class="deck-stat-label">„Éõ„É≠„É°„É≥</div>
            <div class="deck-stat-value">${stats.holomenCount}Êûö</div>
          </div>
          <div class="deck-stat-item">
            <div class="deck-stat-label">„Çµ„Éù„Éº„Éà</div>
            <div class="deck-stat-value">${stats.supportCount}Êûö</div>
          </div>
        </div>

        ${!validation.isValid ? `
          <div class="deck-errors">
            <h4>„Ç®„É©„Éº:</h4>
            <ul>
              ${validation.errors.map(error => `<li>${error}</li>`).join('')}
            </ul>
          </div>
        ` : ''}

        <div class="deck-color-distribution">
          <h4>Ëâ≤ÂàÜÂ∏É:</h4>
          <div class="color-chips">
            ${Object.entries(stats.colorDistribution).map(([color, count]) => 
              `<span class="color-chip color-${color}">${color}: ${count}Êûö</span>`
            ).join('')}
          </div>
        </div>
      `;

    } catch (error) {
      console.error("„Éá„ÉÉ„Ç≠„Éó„É¨„Éì„É•„Éº„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó:", error);
      previewContainer.innerHTML = `
        <div style="color: red; text-align: center;">
          <p>„Éá„ÉÉ„Ç≠„Éó„É¨„Éì„É•„Éº„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</p>
          <p>„Ç´„Éº„Éâ„Éá„Éº„Çø„Éô„Éº„Çπ„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Å™„ÅÑÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô</p>
        </div>
      `;
    }
  }

  async confirmDeckSelection() {
    if (!this.selectedDeck) return;

    try {
      const deckCardIds = this.deckManager.getDeck(this.selectedDeck);
      const deck = await this.deckManager.convertDeckToCards(deckCardIds);
      const validation = this.deckManager.validateDeck(deck);

      if (!validation.isValid) {
        if (!confirm(`„Åì„ÅÆ„Éá„ÉÉ„Ç≠„Å´„ÅØ‰ª•‰∏ã„ÅÆÂïèÈ°å„Åå„ÅÇ„Çä„Åæ„Åô:\n${validation.errors.join('\n')}\n\n„Åù„Çå„Åß„ÇÇ‰ΩøÁî®„Åó„Åæ„Åô„ÅãÔºü`)) {
          return;
        }
      }

      // „Éê„Éà„É´„Ç®„É≥„Ç∏„É≥„Å´„Éá„ÉÉ„Ç≠„ÇíË®≠ÂÆö
      this.applyDeckToBattle(deck);

      // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
      document.getElementById('deck-selection-modal').remove();

      const playerName = this.playerId === 1 ? '„Éó„É¨„Ç§„É§„Éº' : 'Áõ∏Êâã';
      alert(`„Éá„ÉÉ„Ç≠„Äå${this.selectedDeck}„Äç„Åå${playerName}Áî®„Å´ÈÅ©Áî®„Åï„Çå„Åæ„Åó„ÅüÔºÅ`);

    } catch (error) {
      console.error("„Éá„ÉÉ„Ç≠ÈÅ©Áî®„Ç®„É©„Éº:", error);
      alert("„Éá„ÉÉ„Ç≠„ÅÆÈÅ©Áî®„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
    }
  }

  applyDeckToBattle(deck) {
    if (!this.battleEngine.players[this.playerId]) {
      console.error(`„Éó„É¨„Ç§„É§„Éº${this.playerId}„ÅåÂ≠òÂú®„Åó„Åæ„Åõ„Çì!`);
      return;
    }

    const player = this.battleEngine.players[this.playerId];

    // „Éá„ÉÉ„Ç≠„Çí„ÇØ„É™„Ç¢
    player.deck = [];
    player.yellDeck = [];
    player.oshi = null;

    // Êñ∞„Åó„ÅÑ„Éá„ÉÉ„Ç≠„ÇíË®≠ÂÆö
    player.deck = [...deck.holomen, ...deck.support];
    player.yellDeck = [...deck.yell];
    player.oshi = deck.oshi;

    // „Éá„ÉÉ„Ç≠„Çí„Ç∑„É£„ÉÉ„Éï„É´
    this.battleEngine.shuffleDeck(this.playerId);

    console.log(`„Éá„ÉÉ„Ç≠„Äå${this.selectedDeck}„Äç„Çí„Éó„É¨„Ç§„É§„Éº${this.playerId}„Å´ÈÅ©Áî®„Åó„Åæ„Åó„Åü`);
    
    // UI„ÇíÊõ¥Êñ∞
    this.battleEngine.updateUI();
    
    // „Ç≤„Éº„É†Áä∂Ê≥Å„ÇÇÊõ¥Êñ∞
    this.battleEngine.updateGameStatus();
  }
}

// „Ç∞„É≠„Éº„Éê„É´„Ç¢„ÇØ„Çª„ÇπÁî®
window.DeckManager = DeckManager;
window.DeckSelectionUI = DeckSelectionUI;
