# 状態遷移とフロー詳細 - 2024年8月更新版

## ゲーム全体の状態遷移

```mermaid
stateDiagram-v2
    [*] --> 初期化
    初期化 --> カード効果準備 : initializeSystem()
    カード効果準備 --> デッキ選択 : prepareDeckCards()
    デッキ選択 --> ゲーム開始準備 : デッキ設定完了
    ゲーム開始準備 --> カード効果初期化 : initializeDeckCards()
    カード効果初期化 --> ゲーム開始 : 両プレイヤー準備完了
    ゲーム開始 --> 先行決定 : startGame()
    先行決定 --> マリガン : 先行後攻決定
    マリガン --> プレイヤー1ターン : マリガン完了
    
    state プレイヤー1ターン {
        [*] --> リセットフェーズ
        リセットフェーズ --> ドローフェーズ : nextPhase()
        ドローフェーズ --> エールフェーズ : nextPhase()
        エールフェーズ --> メインフェーズ : nextPhase()
        メインフェーズ --> パフォーマンスフェーズ : nextPhase()
        パフォーマンスフェーズ --> エンドフェーズ : nextPhase()
        エンドフェーズ --> [*] : endTurn()
    }
    
    プレイヤー1ターン --> プレイヤー2ターン : ターン終了
    プレイヤー2ターン --> プレイヤー1ターン : ターン終了
    プレイヤー1ターン --> ゲーム終了 : 勝利条件満了
    プレイヤー2ターン --> ゲーム終了 : 勝利条件満了
    ゲーム終了 --> [*]
```

## フェーズ詳細フロー

### リセットフェーズ (Phase: 'reset')
```mermaid
flowchart TD
    A[リセットフェーズ開始] --> B[カード状態リセット]
    B --> C[一時的効果クリア]
    C --> D[ホロメン立たせる]
    D --> E[RESET処理実行]
    E --> F[次フェーズへ]
```

### ドローフェーズ (Phase: 'draw')
```mermaid
flowchart TD
    A[ドローフェーズ開始] --> B{ターン1?}
    B -->|Yes| C[初期手札配布]
    B -->|No| D[カード1枚ドロー]
    C --> E[マリガン選択]
    D --> F[手札上限チェック]
    E --> F
    F --> G[次フェーズへ]
```

### エールフェーズ (Phase: 'cheer')
```mermaid
flowchart TD
    A[エールフェーズ開始] --> B[エールデッキからドロー]
    B --> C[配置先選択]
    C --> D{配置先有効?}
    D -->|Yes| E[エール配置]
    D -->|No| F[アーカイブへ]
    E --> G[次フェーズへ]
    F --> G
```

### メインフェーズ (Phase: 'main')
```mermaid
flowchart TD
    A[メインフェーズ開始] --> B[手札からカード選択]
    B --> C{カードタイプ?}
    C -->|ホロメン| D[配置処理]
    C -->|ツール/イベント| E[効果発動]
    C -->|ホロパワー| F[ホロパワー配置]
    D --> G{配置可能?}
    G -->|Yes| H[配置実行]
    G -->|No| I[エラー表示]
    E --> J[効果処理]
    F --> K[ホロパワー処理]
    H --> L[アクション継続?]
    I --> L
    J --> L
    K --> L
    L -->|Yes| B
    L -->|No| M[次フェーズへ]
```

### パフォーマンスフェーズ (Phase: 'performance') ⭐更新
```mermaid
flowchart TD
    A[パフォーマンスフェーズ開始] --> B[PerformanceManager初期化]
    B --> C[攻撃可能カード検出]
    C --> D[攻撃可能カードハイライト]
    D --> E{ユーザー選択}
    E -->|攻撃カード選択| F[攻撃者設定]
    E -->|スキップ| N[次フェーズへ]
    F --> G[攻撃対象検出]
    G --> H[対象ハイライト]
    H --> I{対象選択}
    I -->|有効対象| J[攻撃実行]
    I -->|キャンセル| D
    J --> K[ダメージ計算・適用]
    K --> L{カード撃破?}
    L -->|Yes| M[撃破処理・ライフ→エール]
    L -->|No| O[攻撃完了]
    M --> O
    O --> P{続行?}
    P -->|Yes| C
    P -->|No| N
```

### エンドフェーズ (Phase: 'end') ⭐新規追加
```mermaid
flowchart TD
    A[エンドフェーズ開始] --> B[ターン終了効果発動]
    B --> C[手札上限チェック]
    C --> D{手札超過?}
    D -->|Yes| E[手札調整]
    D -->|No| F[ターン終了処理]
    E --> F
    F --> G[効果状態リセット]
    G --> H[攻撃済み状態リセット]
    H --> I[相手ターンへ]
```

## カード効果発動フロー ⭐新システム

### 効果発動システム全体フロー
```mermaid
flowchart TD
    A[カード効果トリガー] --> B[ScalableCardEffectManager]
    B --> C{効果読み込み済み?}
    C -->|No| D[動的読み込み実行]
    C -->|Yes| E[効果実行判定]
    D --> E
    E --> F{発動条件満足?}
    F -->|No| G[発動失敗通知]
    F -->|Yes| H[効果実行]
    H --> I{効果タイプ}
    I -->|ブルーム| J[ブルーム効果処理]
    I -->|コラボ| K[コラボ効果処理]
    I -->|ギフト| L[ギフト効果処理]
    I -->|サポート| M[サポート効果処理]
    J --> N[効果使用済みマーク]
    K --> N
    L --> O[継続効果登録]
    M --> P[一時効果適用]
    N --> Q[状態更新]
    O --> Q
    P --> Q
    Q --> R[UI更新]
    G --> S[処理終了]
    R --> S
```

### カード効果動的読み込みフロー
```mermaid
flowchart TD
    A[効果読み込み要求] --> B{メタデータ存在?}
    B -->|No| C[メタデータ読み込み]
    B -->|Yes| D[効果パターン判定]
    C --> D
    D --> E{カスタム効果?}
    E -->|Yes| F[個別ファイル読み込み]
    E -->|No| G[パターンテンプレート取得]
    F --> H[効果オブジェクト生成]
    G --> I[テンプレート効果生成]
    H --> J[効果キャッシュ登録]
    I --> J
    J --> K[読み込み完了]
```

## カード配置フロー ⭐更新

```mermaid
flowchart TD
    A[カードドラッグ開始] --> B[PlacementController初期化]
    B --> C[ドラッグ可能性チェック]
    C --> D{ドラッグ可能?}
    D -->|No| E[ドラッグ無効]
    D -->|Yes| F[ドラッグ中状態設定]
    F --> G[有効ドロップゾーン計算]
    G --> H[ドロップゾーンハイライト]
    H --> I[ドラッグ追跡開始]
    I --> J[ドロップ検出]
    J --> K{有効エリア?}
    K -->|No| L[元位置復帰]
    K -->|Yes| M[StateManager配置検証]
    M --> N{配置ルール適合?}
    N -->|No| O[エラー表示]
    N -->|Yes| P[配置実行]
    P --> Q[状態更新]
    Q --> R[CardDisplayManager更新]
    R --> S[配置完了]
    L --> T[ドラッグ終了]
    O --> T
    S --> T
    E --> T
```

## AI思考フロー ⭐更新

```mermaid
flowchart TD
    A[CPUターン開始] --> B[HololiveCPULogic初期化]
    B --> C[現在状況分析]
    C --> D[StateManager状態取得]
    D --> E[可能アクション列挙]
    E --> F[各アクションスコア計算]
    F --> G[最適アクション選択]
    G --> H{フェーズ別処理}
    H -->|ドロー| I[自動ドロー実行]
    H -->|エール| J[エール配置AI]
    H -->|メイン| K[カード配置AI]
    H -->|パフォーマンス| L[攻撃AI]
    I --> M[フェーズ進行判定]
    J --> N[配置効果考慮]
    K --> O[戦略的配置実行]
    L --> P[攻撃優先度計算]
    N --> M
    O --> M
    P --> M
    M --> Q{フェーズ継続?}
    Q -->|Yes| H
    Q -->|No| R[ターン終了]
```

## データフロー ⭐大幅更新

### 状態更新フロー（新アーキテクチャ）
```mermaid
flowchart LR
    A[ユーザーアクション] --> B[対応Manager]
    B --> C[StateManager]
    C --> D[プロキシ状態更新]
    D --> E[変更検証]
    E --> F{検証結果}
    F -->|エラー| G[エラーハンドリング]
    F -->|成功| H[状態コミット]
    H --> I[変更通知発行]
    I --> J[UI更新トリガー]
    I --> K[他モジュール通知]
    J --> L[CardDisplayManager]
    K --> M[関連Manager更新]
    L --> N[デバウンス処理]
    N --> O[DOM更新]
    G --> P[フォールバック処理]
```

### カード表示更新フロー（最適化版）
```mermaid
flowchart LR
    A[状態変更通知] --> B[CardDisplayManager]
    B --> C[デバウンスチェック]
    C --> D{更新必要?}
    D -->|No| E[更新スキップ]
    D -->|Yes| F[差分計算]
    F --> G[エリア別処理]
    G --> H[カード要素差分更新]
    H --> I[スタイル最適化適用]
    I --> J[イベントバインド更新]
    J --> K[アニメーション実行]
    K --> L[DOM反映]
    L --> M[更新完了通知]
```

### カード効果実行データフロー
```mermaid
flowchart LR
    A[効果発動要求] --> B[ScalableCardEffectManager]
    B --> C[効果読み込み]
    C --> D[実行コンテキスト構築]
    D --> E[効果実行]
    E --> F[結果処理]
    F --> G[StateManager更新]
    G --> H[UI反映]
    H --> I[ログ出力]
    I --> J[統計更新]
```

## イベント処理チェーン ⭐大幅更新

### カードクリックイベント（新統合システム）
```mermaid
flowchart TD
    A[カードクリック] --> B[CardInteractionManager.handleCardClick]
    B --> C[カード情報取得]
    C --> D[showCardInfo実行]
    D --> E[右パネル情報更新]
    E --> F[アクションマーク表示判定]
    F --> G{手動効果あり?}
    G -->|Yes| H[showActionMarks実行]
    G -->|No| I[詳細表示のみ]
    H --> J[アクションボタン生成]
    J --> K{ユーザーアクション選択}
    K -->|効果発動| L[activateCardEffect]
    K -->|移動| M[initiateMoveCard]
    K -->|ブルーム| N[initiateBloom]
    K -->|バトンタッチ| O[initiateBatonTouch]
    L --> P[ScalableCardEffectManager.executeEffect]
    P --> Q[効果処理実行]
    Q --> R[結果に基づく後処理]
    R --> S[状態更新]
    S --> T[UI全体更新]
    I --> U[モーダル表示]
    M --> V[移動処理]
    N --> W[ブルーム処理]
    O --> X[バトンタッチ処理]
    V --> S
    W --> S
    X --> S
```

### フェーズ進行イベント（強化版）
```mermaid
flowchart TD
    A[フェーズボタンクリック] --> B[PhaseController.nextPhase]
    B --> C[現在フェーズ取得]
    C --> D[フェーズ進行可能性検証]
    D --> E{進行可能?}
    E -->|No| F[エラーメッセージ表示]
    E -->|Yes| G[現在フェーズ終了処理]
    G --> H[次フェーズ開始処理]
    H --> I{フェーズタイプ判定}
    I -->|パフォーマンス| J[PerformanceManager起動]
    I -->|その他| K[標準フェーズ処理]
    J --> L[攻撃可能カード検出]
    L --> M[UI更新]
    K --> M
    M --> N[フェーズ表示更新]
    N --> O[状態保存]
    F --> P[処理終了]
    O --> P
```

### ターン終了イベント（統合処理）
```mermaid
flowchart TD
    A[ターン終了ボタン] --> B[TurnManager.endTurn]
    B --> C[エンドフェーズ実行]
    C --> D[ターン終了効果発動]
    D --> E[手札上限チェック]
    E --> F[ターン状態リセット]
    F --> G[効果状態クリア]
    G --> H[相手ターン準備]
    H --> I[プレイヤー切り替え]
    I --> J[新ターン初期化]
    J --> K[リセットフェーズ開始]
    K --> L[UI全体更新]
    L --> M[ターン終了完了]
```

### カード効果チェーン（新システム）
```mermaid
flowchart TD
    A[効果発動トリガー] --> B[効果タイプ判定]
    B --> C{トリガータイプ}
    C -->|play| D[配置時効果]
    C -->|activate| E[起動効果]
    C -->|bloom| F[ブルーム効果]
    C -->|collab| G[コラボ効果]
    D --> H[ScalableCardEffectManager]
    E --> H
    F --> H
    G --> H
    H --> I[動的読み込み確認]
    I --> J{効果存在?}
    J -->|No| K[効果なし通知]
    J -->|Yes| L[実行条件チェック]
    L --> M{条件満足?}
    M -->|No| N[発動失敗]
    M -->|Yes| O[効果実行]
    O --> P[結果処理]
    P --> Q[チェーン効果確認]
    Q --> R{追加効果?}
    R -->|Yes| S[チェーン効果実行]
    R -->|No| T[効果完了]
    S --> P
    K --> U[処理終了]
    N --> U
    T --> U
```

## エラーハンドリングフロー ⭐大幅強化

```mermaid
flowchart TD
    A[エラー発生] --> B[エラー分類]
    B --> C{エラータイプ}
    C -->|UI検証エラー| D[ユーザー通知]
    C -->|システムエラー| E[ログ出力・統計]
    C -->|データエラー| F[データ復旧試行]
    C -->|ネットワークエラー| G[再試行機構]
    C -->|カード効果エラー| H[効果フォールバック]
    
    D --> I[エラーメッセージ表示]
    I --> J[処理継続]
    
    E --> K[デバッグ情報収集]
    K --> L[フォールバック処理]
    L --> M[最小限機能継続]
    
    F --> N{復旧成功?}
    N -->|Yes| O[正常復帰]
    N -->|No| P[セーフモード移行]
    
    G --> Q[接続再試行]
    Q --> R{再試行成功?}
    R -->|Yes| S[処理再開]
    R -->|No| T[オフラインモード]
    
    H --> U[代替効果実行]
    U --> V[効果無効化通知]
    
    O --> W[状態同期]
    P --> X[ユーザー選択提示]
    S --> W
    T --> Y[ローカル処理継続]
    V --> Z[処理継続]
    
    W --> AA[処理完了]
    X --> BB[ユーザー操作待ち]
    Y --> AA
    Z --> AA
    J --> AA
    M --> AA
    BB --> AA
```

## パフォーマンス最適化ポイント ⭐新規追加

### 1. カード効果システム最適化
```mermaid
flowchart LR
    A[カード選択] --> B[メタデータ確認]
    B --> C{効果存在?}
    C -->|No| D[効果なし高速処理]
    C -->|Yes| E[遅延読み込み判定]
    E --> F{読み込み済み?}
    F -->|Yes| G[キャッシュ実行]
    F -->|No| H[動的読み込み]
    H --> I[効果実行]
    G --> I
    I --> J[結果キャッシュ]
    D --> K[処理完了]
    J --> K
```

### 2. UI更新最適化
```mermaid
flowchart LR
    A[状態変更] --> B[デバウンス判定]
    B --> C{更新必要?}
    C -->|No| D[更新スキップ]
    C -->|Yes| E[差分計算]
    E --> F[最小限更新]
    F --> G[DOM最適化]
    G --> H[更新完了]
    D --> H
```

### 3. メモリ管理最適化
- **カード効果の自動アンロード**: 使用頻度の低い効果を自動解放
- **イベントリスナーの適切な管理**: メモリリーク防止
- **DOM要素の再利用**: 不要な生成を削減
- **キャッシュサイズ制限**: メモリ使用量の制御

### 4. 非同期処理最適化
- **バッチ読み込み**: 複数カード効果の並列読み込み
- **優先度付きキュー**: 重要な処理を優先実行
- **タイムスライシング**: 重い処理の分割実行
- **プリロード戦略**: 予測的な事前読み込み
