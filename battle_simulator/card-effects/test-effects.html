<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚«ãƒ¼ãƒ‰åŠ¹æœå‹•ä½œãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .card-test {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            background: #fafafa;
        }
        .card-test.success {
            border-color: #4caf50;
            background: #e8f5e8;
        }
        .card-test.error {
            border-color: #f44336;
            background: #fdeaea;
        }
        .test-result {
            font-weight: bold;
            margin-top: 10px;
        }
        .effect-list {
            margin-left: 20px;
        }
        .effect-item {
            padding: 5px 0;
            border-bottom: 1px dotted #ccc;
        }
        .test-button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #1976d2;
        }
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }
        .status-success { background: #4caf50; }
        .status-error { background: #f44336; }
        .status-warning { background: #ff9800; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ§ª ã‚«ãƒ¼ãƒ‰åŠ¹æœå‹•ä½œãƒ†ã‚¹ãƒˆ</h1>
        <p>å®Ÿè£…æ¸ˆã¿ã‚«ãƒ¼ãƒ‰åŠ¹æœã®èª­ã¿è¾¼ã¿ã¨åŸºæœ¬å‹•ä½œã‚’ç¢ºèªã—ã¾ã™ã€‚</p>
        
        <button class="test-button" onclick="runAllTests()">ğŸš€ å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
        <button class="test-button" onclick="clearResults()">ğŸ—‘ï¸ çµæœã‚¯ãƒªã‚¢</button>
        
        <div id="testResults"></div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«UI -->
    <script src="../../js/modal-ui.js"></script>
    
    <!-- æ¨¡æ“¬ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— -->
    <script>
        // æ¨¡æ“¬ãƒãƒˆãƒ«ã‚¨ãƒ³ã‚¸ãƒ³ç’°å¢ƒ
        window.CardEffectUtils = class {
            constructor(battleEngine) {
                this.battleEngine = battleEngine;
            }
            
            getStageHolomens(player) {
                return [];
            }
            
            dealDamage(target, amount, options) {
                console.log(`ğŸ’¥ ãƒ€ãƒ¡ãƒ¼ã‚¸å‡¦ç†: ${amount} â†’ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${target}`);
                return { success: true, damage: amount };
            }
            
            updateDisplay() {
                console.log('ğŸ”„ UIæ›´æ–°');
            }
            
            drawCards(player, count) {
                console.log(`ğŸ“„ ${count}æšãƒ‰ãƒ­ãƒ¼`);
                return Array(count).fill({ name: 'ãƒ†ã‚¹ãƒˆã‚«ãƒ¼ãƒ‰' });
            }
        };

        // æ¨¡æ“¬ãƒãƒˆãƒ«ã‚¨ãƒ³ã‚¸ãƒ³
        const mockBattleEngine = {
            gameState: {
                currentPlayer: 0,
                currentPhase: 3
            },
            players: [
                { 
                    hand: [], 
                    deck: Array(30).fill({ name: 'ãƒ†ã‚¹ãƒˆã‚«ãƒ¼ãƒ‰', card_type: 'ãƒ›ãƒ­ãƒ¡ãƒ³', bloom_level: 'Debut' }),
                    archive: []
                },
                { 
                    hand: [], 
                    deck: Array(30).fill({ name: 'ãƒ†ã‚¹ãƒˆã‚«ãƒ¼ãƒ‰' }),
                    archive: []
                }
            ],
            modalUI: new ModalUI()
        };

        // ã‚«ãƒ¼ãƒ‰åŠ¹æœç™»éŒ²ã‚·ã‚¹ãƒ†ãƒ 
        window.cardEffects = {};
        window.pendingCardEffects = [];
        
        // ãƒ†ã‚¹ãƒˆå¯¾è±¡ã‚«ãƒ¼ãƒ‰
        const testCards = [
            'hBP01-104', 'hBP02-042', 'hBP02-045', 'hBP02-076', 'hBP02-084',
            'hBP04-004', 'hBP04-043', 'hBP04-044', 'hBP04-045', 'hBP04-046',
            'hBP04-047', 'hBP04-048', 'hBP04-089', 'hSD01-014', 'hSD01-016',
            'hSD01-017', 'hY04-001'
        ];

        // ãƒ†ã‚¹ãƒˆçµæœè¡¨ç¤º
        function displayTestResult(cardId, result) {
            const resultsDiv = document.getElementById('testResults');
            const cardDiv = document.createElement('div');
            cardDiv.className = `card-test ${result.success ? 'success' : 'error'}`;
            
            const effectsList = result.effects.map(effect => 
                `<div class="effect-item">
                    <span class="status-badge ${effect.working ? 'status-success' : 'status-error'}">
                        ${effect.working ? 'âœ“' : 'âœ—'}
                    </span>
                    ${effect.type}: ${effect.name}
                </div>`
            ).join('');
            
            cardDiv.innerHTML = `
                <h3>${cardId} ${result.cardName ? `(${result.cardName})` : ''}</h3>
                <div class="test-result">
                    <span class="status-badge ${result.success ? 'status-success' : 'status-error'}">
                        ${result.success ? 'âœ… æ­£å¸¸' : 'âŒ ã‚¨ãƒ©ãƒ¼'}
                    </span>
                    ${result.message}
                </div>
                <div class="effect-list">
                    ${effectsList}
                </div>
                ${result.error ? `<div style="color: red; margin-top: 10px;">ã‚¨ãƒ©ãƒ¼è©³ç´°: ${result.error}</div>` : ''}
            `;
            
            resultsDiv.appendChild(cardDiv);
        }

        // å€‹åˆ¥ã‚«ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ
        async function testCard(cardId) {
            try {
                // ã‚«ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
                const script = document.createElement('script');
                script.src = `cards/${cardId}.js`;
                
                return new Promise((resolve) => {
                    script.onload = () => {
                        try {
                            // ã‚«ãƒ¼ãƒ‰åŠ¹æœã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå–å¾—
                            const effectVar = `cardEffect_${cardId.replace(/-/g, '_')}`;
                            const cardEffect = window[effectVar];
                            
                            if (!cardEffect) {
                                resolve({
                                    success: false,
                                    message: 'ã‚«ãƒ¼ãƒ‰åŠ¹æœã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
                                    effects: []
                                });
                                return;
                            }

                            // åŠ¹æœã®è©³ç´°ãƒã‚§ãƒƒã‚¯
                            const effects = [];
                            if (cardEffect.effects) {
                                for (const [key, effect] of Object.entries(cardEffect.effects)) {
                                    const working = 
                                        typeof effect.condition === 'function' &&
                                        typeof effect.effect === 'function';
                                    
                                    effects.push({
                                        type: effect.type || key,
                                        name: effect.name || 'Unknown',
                                        working: working
                                    });
                                }
                            }

                            const allWorking = effects.length > 0 && effects.every(e => e.working);
                            
                            resolve({
                                success: allWorking,
                                cardName: cardEffect.cardName,
                                message: `${effects.length}å€‹ã®åŠ¹æœã‚’æ¤œå‡º`,
                                effects: effects
                            });
                            
                        } catch (error) {
                            resolve({
                                success: false,
                                message: 'ã‚«ãƒ¼ãƒ‰åŠ¹æœã®è§£æã«å¤±æ•—',
                                error: error.message,
                                effects: []
                            });
                        }
                    };
                    
                    script.onerror = () => {
                        resolve({
                            success: false,
                            message: 'ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—',
                            effects: []
                        });
                    };
                    
                    document.head.appendChild(script);
                });
                
            } catch (error) {
                return {
                    success: false,
                    message: 'ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¨ãƒ©ãƒ¼',
                    error: error.message,
                    effects: []
                };
            }
        }

        // å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        async function runAllTests() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '<h2>ğŸ”„ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</h2>';
            
            let successCount = 0;
            const totalCards = testCards.length;
            
            for (const cardId of testCards) {
                const result = await testCard(cardId);
                displayTestResult(cardId, result);
                
                if (result.success) {
                    successCount++;
                }
                
                // å°‘ã—å¾…ã¤ï¼ˆèª­ã¿è¾¼ã¿è² è·è»½æ¸›ï¼‰
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            // ã‚µãƒãƒªãƒ¼è¡¨ç¤º
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'test-container';
            summaryDiv.innerHTML = `
                <h2>ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼</h2>
                <div style="font-size: 18px; margin: 10px 0;">
                    <span class="status-badge ${successCount === totalCards ? 'status-success' : 'status-warning'}">
                        ${successCount}/${totalCards} ã‚«ãƒ¼ãƒ‰æ­£å¸¸
                    </span>
                </div>
                <p>æˆåŠŸç‡: ${Math.round(successCount/totalCards*100)}%</p>
            `;
            
            resultsDiv.insertBefore(summaryDiv, resultsDiv.firstChild);
        }

        // çµæœã‚¯ãƒªã‚¢
        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
        }

        // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        document.getElementById('testResults').innerHTML = `
            <div class="card-test">
                <h3>ğŸ“‹ ãƒ†ã‚¹ãƒˆæº–å‚™å®Œäº†</h3>
                <p>ã€Œå…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã€å®Ÿè£…æ¸ˆã¿${testCards.length}æšã®ã‚«ãƒ¼ãƒ‰åŠ¹æœã‚’ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„ã€‚</p>
                <p><strong>ãƒ†ã‚¹ãƒˆå†…å®¹:</strong></p>
                <ul>
                    <li>âœ… ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ç¢ºèª</li>
                    <li>âœ… åŠ¹æœã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ç¢ºèª</li>
                    <li>âœ… conditioné–¢æ•°å­˜åœ¨ç¢ºèª</li>
                    <li>âœ… effecté–¢æ•°å­˜åœ¨ç¢ºèª</li>
                    <li>âœ… ãƒ¢ãƒ¼ãƒ€ãƒ«å¯¾å¿œç¢ºèª</li>
                </ul>
            </div>
        `;
    </script>
</body>
</html>
