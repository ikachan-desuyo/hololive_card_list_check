/**
 * ãƒ©ãƒŸã‚£ãƒ‡ãƒƒã‚­ã‚«ãƒ¼ãƒ‰åŠ¹æœå®Ÿè£…
 * é›ªèŠ±ãƒ©ãƒŸã‚£é–¢é€£ã®ã‚«ãƒ¼ãƒ‰åŠ¹æœ
 */

// é›ªèŠ±ãƒ©ãƒŸã‚£ (hBP04-048_RR) - 2ndãƒ–ãƒ«ãƒ¼ãƒ 
const YukihanaLamyRR = {
  cardId: 'hBP04-048_RR',
  name: 'é›ªèŠ±ãƒ©ãƒŸã‚£',
  type: 'holomen',
  triggers: [
    { type: 'on_bloom', timing: 'on_bloom' } // ãƒ–ãƒ«ãƒ¼ãƒ ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®ã¿
  ],
  
  // ãƒ–ãƒ«ãƒ¼ãƒ ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã€Œãƒ¦ãƒ‹ãƒ¼ãƒªã‚¢ã®ä»¤å¬¢ã€
  onBloomEffect: async (card, context, battleEngine) => {
    const utils = battleEngine.cardEffectTriggerSystem.utils;
    const currentPlayer = battleEngine.gameState.currentPlayer;
    
    try {
      // ã€ˆé›ªæ°‘ã€‰ãŒä»˜ã„ã¦ã„ã‚‹ã€ˆé›ªèŠ±ãƒ©ãƒŸã‚£ã€‰ã‚’æ¤œç´¢
      const stageHolomens = utils.getStageHolomens(currentPlayer);
      const lamyWithYukimin = stageHolomens.filter(h => 
        h.card.name && h.card.name.includes('é›ªèŠ±ãƒ©ãƒŸã‚£') &&
        h.attachments && h.attachments.some(att => att.name && att.name.includes('é›ªæ°‘'))
      );
      
      if (lamyWithYukimin.length === 0) {
        return { success: false, reason: 'ã€ˆé›ªæ°‘ã€‰ãŒä»˜ã„ã¦ã„ã‚‹ã€ˆé›ªèŠ±ãƒ©ãƒŸã‚£ã€‰ãŒã„ã¾ã›ã‚“' };
      }
      
      // ã‚¨ãƒ¼ãƒ«ãƒ‡ãƒƒã‚­ã®ä¸Šã‹ã‚‰1æšã‚’å¯¾è±¡ã®ãƒ©ãƒŸã‚£ã«é€ã‚‹
      const player = battleEngine.players[currentPlayer];
      if (player.yellDeck && player.yellDeck.length > 0) {
        const yellCard = player.yellDeck.shift();
        const targetLamy = lamyWithYukimin[0]; // æœ€åˆã®æ¡ä»¶ã‚’æº€ãŸã™ãƒ©ãƒŸã‚£
        
        if (!targetLamy.attachments) targetLamy.attachments = [];
        targetLamy.attachments.push(yellCard);
        
        utils.updateDisplay();
        
        return {
          success: true,
          message: `${targetLamy.card.name}ã«ã‚¨ãƒ¼ãƒ«1æšã‚’ä»˜ã‘ã¾ã—ãŸ`
        };
      }
      
      return { success: false, reason: 'ã‚¨ãƒ¼ãƒ«ãƒ‡ãƒƒã‚­ã«ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“' };
    } catch (error) {
      console.error('ãƒ¦ãƒ‹ãƒ¼ãƒªã‚¢ã®ä»¤å¬¢ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚¨ãƒ©ãƒ¼:', error);
      return { success: false, reason: 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', error };
    }
  },
  
  // ã‚¢ãƒ¼ãƒ„ã€Œä»Šæ—¥ã‚‚ç¥ç¦ãŒã‚ã‚Šã¾ã™ã‚ˆã†ã«ã€ï¼ˆæ‰‹å‹•ç™ºå‹•ï¼‰
  execute: async (card, context, battleEngine) => {
    const utils = battleEngine.cardEffectTriggerSystem.utils;
    const currentPlayer = battleEngine.gameState.currentPlayer;
    const opponent = currentPlayer === 1 ? 2 : 1;
    
    try {
      // ã“ã®ãƒ›ãƒ­ãƒ¡ãƒ³ã®ã‚¨ãƒ¼ãƒ«1æšã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã§ãã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      const cardPosition = utils.findCardPosition(currentPlayer, card.id);
      if (!cardPosition || !cardPosition.attachments || cardPosition.attachments.length === 0) {
        return { success: false, reason: 'ã‚¨ãƒ¼ãƒ«ãŒä»˜ã„ã¦ã„ã¾ã›ã‚“' };
      }
      
      // ã‚¨ãƒ¼ãƒ«1æšã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
      const yellToArchive = cardPosition.attachments.shift();
      const archiveResult = utils.archiveCards(currentPlayer, [yellToArchive]);
      
      if (archiveResult.success) {
        // ç›¸æ‰‹ã®ã‚»ãƒ³ã‚¿ãƒ¼ãƒ›ãƒ­ãƒ¡ãƒ³ã‹ãƒãƒƒã‚¯ãƒ›ãƒ­ãƒ¡ãƒ³ã«ç‰¹æ®Šãƒ€ãƒ¡ãƒ¼ã‚¸30
        const opponentHolomens = utils.getStageHolomens(opponent);
        if (opponentHolomens.length > 0) {
          // ç°¡æ˜“å®Ÿè£…ï¼šæœ€åˆã®ãƒ›ãƒ­ãƒ¡ãƒ³ã«ãƒ€ãƒ¡ãƒ¼ã‚¸
          const target = opponentHolomens[0];
          const damageResult = utils.dealDamage(opponent, 30, {
            source: card,
            type: 'special',
            target: target.card.id
          });
          
          utils.updateDisplay();
          
          return {
            success: true,
            message: `ã‚¨ãƒ¼ãƒ«ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã—ã€${target.card.name}ã«ç‰¹æ®Šãƒ€ãƒ¡ãƒ¼ã‚¸30ã‚’ä¸ãˆã¾ã—ãŸ`
          };
        }
      }
      
      return { success: false, reason: 'åŠ¹æœã‚’å®Ÿè¡Œã§ãã¾ã›ã‚“ã§ã—ãŸ' };
    } catch (error) {
      console.error('ä»Šæ—¥ã‚‚ç¥ç¦ãŒã‚ã‚Šã¾ã™ã‚ˆã†ã«ã‚¨ãƒ©ãƒ¼:', error);
      return { success: false, reason: 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', error };
    }
  }
};

// é›ªèŠ±ãƒ©ãƒŸã‚£ (hBP04-043_C) - åŸºæœ¬å½¢
const YukihanaLamyC = {
  cardId: 'hBP04-043_C',
  name: 'é›ªèŠ±ãƒ©ãƒŸã‚£',
  type: 'holomen',
  
  // åŸºæœ¬çš„ãªãƒ›ãƒ­ãƒ¡ãƒ³ã‚«ãƒ¼ãƒ‰ï¼ˆç‰¹æ®ŠåŠ¹æœãªã—ï¼‰
  execute: async (card, context, battleEngine) => {
    return {
      success: true,
      message: 'é›ªèŠ±ãƒ©ãƒŸã‚£ãŒå ´ã«å‡ºã¾ã—ãŸ'
    };
  }
};

// é›ªæ°‘ (hBP04-106_U) - ãƒ•ã‚¡ãƒ³ã‚«ãƒ¼ãƒ‰
const Yukimin = {
  cardId: 'hBP04-106_U',
  name: 'é›ªæ°‘',
  type: 'fan',
  triggers: [{ type: 'gift', timing: 'gift' }], // ã‚®ãƒ•ãƒˆåŠ¹æœ
  
  // ã‚®ãƒ•ãƒˆåŠ¹æœï¼ˆå ´ã«ã„ã‚‹é–“å¸¸æ™‚ç™ºå‹•ï¼‰
  execute: async (card, context, battleEngine) => {
    const utils = battleEngine.cardEffectTriggerSystem.utils;
    const currentPlayer = battleEngine.gameState.currentPlayer;
    
    try {
      // ä»˜ã‘ã‚‰ã‚ŒãŸãƒ›ãƒ­ãƒ¡ãƒ³ãŒã€ˆé›ªèŠ±ãƒ©ãƒŸã‚£ã€‰ã®å ´åˆã®ç‰¹æ®ŠåŠ¹æœ
      if (context.targetCard && context.targetCard.name && context.targetCard.name.includes('é›ªèŠ±ãƒ©ãƒŸã‚£')) {
        // ãƒ©ãƒŸã‚£ã«é›ªæ°‘ãŒä»˜ã„ãŸæ™‚ã®åŠ¹æœï¼ˆå°†æ¥çš„ã«å®Ÿè£…äºˆå®šï¼‰
        return {
          success: true,
          message: 'é›ªæ°‘ãŒé›ªèŠ±ãƒ©ãƒŸã‚£ã«ä»˜ãã¾ã—ãŸï¼ˆã‚®ãƒ•ãƒˆåŠ¹æœæœ‰åŠ¹ï¼‰'
        };
      }
      
      return {
        success: true,
        message: 'é›ªæ°‘ã®ã‚®ãƒ•ãƒˆåŠ¹æœãŒç™ºå‹•ä¸­'
      };
    } catch (error) {
      console.error('é›ªæ°‘åŠ¹æœã‚¨ãƒ©ãƒ¼:', error);
      return { success: false, reason: 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', error };
    }
  }
};

// ã‚µãƒãƒ¼ãƒˆã‚«ãƒ¼ãƒ‰ä¾‹ï¼šhBP04-101_C
const SupportCard101 = {
  cardId: 'hBP04-101_C',
  name: 'ã‚µãƒãƒ¼ãƒˆã‚«ãƒ¼ãƒ‰',
  type: 'support',
  triggers: [{ type: 'manual_trigger', timing: 'manual_trigger' }],
  
  canActivate: (card, context, battleEngine) => {
    const currentPhase = battleEngine.gameState.currentPhase;
    return currentPhase === 3; // ãƒ¡ã‚¤ãƒ³ãƒ•ã‚§ãƒ¼ã‚ºã®ã¿
  },
  
  execute: async (card, context, battleEngine) => {
    const utils = battleEngine.cardEffectTriggerSystem.utils;
    const currentPlayer = battleEngine.gameState.currentPlayer;
    
    try {
      // åŸºæœ¬çš„ãªãƒ‰ãƒ­ãƒ¼åŠ¹æœï¼ˆã‚«ãƒ¼ãƒ‰ã®è©³ç´°ä»•æ§˜ã«å¿œã˜ã¦èª¿æ•´ï¼‰
      const drawResult = utils.drawCards(currentPlayer, 1);
      utils.updateDisplay();
      
      return {
        success: true,
        message: `${drawResult.cards.length}æšãƒ‰ãƒ­ãƒ¼ã—ã¾ã—ãŸ`
      };
    } catch (error) {
      console.error('ã‚µãƒãƒ¼ãƒˆã‚«ãƒ¼ãƒ‰åŠ¹æœã‚¨ãƒ©ãƒ¼:', error);
      return { success: false, reason: 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', error };
    }
  }
};

// åŸºæœ¬ã‚¨ãƒ¼ãƒ« (hY04-001_C)
const BasicYell = {
  cardId: 'hY04-001_C',
  name: 'åŸºæœ¬ã‚¨ãƒ¼ãƒ«',
  type: 'yell',
  
  execute: async (card, context, battleEngine) => {
    return {
      success: true,
      message: 'åŸºæœ¬ã‚¨ãƒ¼ãƒ«ãŒä»˜ãã¾ã—ãŸ'
    };
  }
};

// ã‚³ãƒ©ãƒœã‚¨ãƒ•ã‚§ã‚¯ãƒˆä¾‹ï¼šä»®æƒ³çš„ãªã‚³ãƒ©ãƒœã‚«ãƒ¼ãƒ‰
const CollabEffectSample = {
  cardId: 'hBP04-999_SAMPLE',
  name: 'ã‚³ãƒ©ãƒœã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚µãƒ³ãƒ—ãƒ«',
  type: 'holomen',
  triggers: [{ type: 'on_collab', timing: 'on_collab' }], // ã‚³ãƒ©ãƒœã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
  
  // ã‚³ãƒ©ãƒœã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆãƒãƒƒã‚¯ã‹ã‚‰ã‚³ãƒ©ãƒœã«ç§»å‹•ã—ãŸæ™‚ã®ã¿ç™ºå‹•ï¼‰
  execute: async (card, context, battleEngine) => {
    const utils = battleEngine.cardEffectTriggerSystem.utils;
    const currentPlayer = battleEngine.gameState.currentPlayer;
    
    try {
      // ãƒ‡ãƒƒã‚­ã‹ã‚‰ã‚«ãƒ¼ãƒ‰ã‚’ãƒ‰ãƒ­ãƒ¼
      const drawResult = utils.drawCards(currentPlayer, 1);
      
      if (drawResult.success) {
        return {
          success: true,
          message: 'ã‚³ãƒ©ãƒœã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼šã‚«ãƒ¼ãƒ‰ã‚’1æšãƒ‰ãƒ­ãƒ¼ã—ã¾ã—ãŸ'
        };
      }
      
      return { success: false, reason: 'ãƒ‰ãƒ­ãƒ¼ã§ãã¾ã›ã‚“ã§ã—ãŸ' };
    } catch (error) {
      console.error('ã‚³ãƒ©ãƒœã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚¨ãƒ©ãƒ¼:', error);
      return { success: false, reason: 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', error };
    }
  }
};

// ã‚«ãƒ¼ãƒ‰åŠ¹æœã‚’ç™»éŒ²
if (typeof window !== 'undefined') {
  if (!window.cardEffects) window.cardEffects = {};
  
  // ãƒ©ãƒŸã‚£ãƒ‡ãƒƒã‚­ã®ã‚«ãƒ¼ãƒ‰åŠ¹æœã‚’ç™»éŒ²
  window.cardEffects['hBP04-048_RR'] = YukihanaLamyRR;
  window.cardEffects['hBP04-043_C'] = YukihanaLamyC;
  window.cardEffects['hBP04-106_U'] = Yukimin;
  window.cardEffects['hBP04-101_C'] = SupportCard101;
  window.cardEffects['hY04-001_C'] = BasicYell;
  window.cardEffects['hBP04-999_SAMPLE'] = CollabEffectSample; // ã‚³ãƒ©ãƒœã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚µãƒ³ãƒ—ãƒ«
  
  console.log('ğŸ¯ ãƒ©ãƒŸã‚£ãƒ‡ãƒƒã‚­ã‚«ãƒ¼ãƒ‰åŠ¹æœã‚’ç™»éŒ²ã—ã¾ã—ãŸ:', {
    'hBP04-048_RR': 'é›ªèŠ±ãƒ©ãƒŸã‚£(RR) - ãƒ–ãƒ«ãƒ¼ãƒ ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ',
    'hBP04-043_C': 'é›ªèŠ±ãƒ©ãƒŸã‚£(C)', 
    'hBP04-106_U': 'é›ªæ°‘ - ã‚®ãƒ•ãƒˆ',
    'hBP04-101_C': 'ã‚µãƒãƒ¼ãƒˆã‚«ãƒ¼ãƒ‰',
    'hY04-001_C': 'åŸºæœ¬ã‚¨ãƒ¼ãƒ«',
    'hBP04-999_SAMPLE': 'ã‚³ãƒ©ãƒœã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚µãƒ³ãƒ—ãƒ«'
  });
}

// Node.jsç’°å¢ƒã§ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
if (typeof module !== 'undefined' && module.exports) {
  module.exports = {
    YukihanaLamyRR,
    YukihanaLamyC,
    Yukimin,
    SupportCard101,
    BasicYell
  };
}
