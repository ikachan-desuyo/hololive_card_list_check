<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ホロライブカード一覧</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      font-size: 15px;
      transition: background 0.3s, color 0.3s;
    }

    .dark {
      background: #222;
      color: #eee;
    }

    .container {
      padding: 10px;
    }

    h2 {
      position: relative;
      text-align: center;
      margin-bottom: 10px;
    }

    .top-nav {
      position: absolute;
      top: 0;
      right: 10px;
    }

    .top-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }

    .filter-group {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 8px;
    }

    .filter-group legend {
      font-weight: bold;
      margin-bottom: 6px;
    }

    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 4px;
    }

    label {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    input[type="text"], select {
      font-size: 15px;
      padding: 4px 6px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      vertical-align: top;
      text-align: left;
    }

    th:nth-child(2) {
      white-space: nowrap;
    }

    td:nth-child(2) {
      min-width: 140px;
      max-width: 180px;
      word-break: break-word;
    }

    td.name-cell .meta {
      margin-top: 4px;
      padding: 4px;
      border-top: 1px dashed #ccc;
      font-size: 13px;
      color: #555;
    }

    td:nth-child(8), th:nth-child(8) {
      width: 40px;
    }

    td:nth-child(9), th:nth-child(9) {
      word-break: break-word;
      min-width: 320px;
    }

    input[type="number"] {
      width: 32px;
      text-align: center;
    }

    img {
      width: 60px;
      cursor: zoom-in;
      border-radius: 4px;
      background: #fff;
      border: 1px solid #ccc;
    }

    #imageModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.85);
      text-align: center;
      z-index: 1000;
      cursor: zoom-out;
    }

    #imageModal img {
      margin-top: 5vh;
      width: 100%;
      height: auto;
      max-height: 100dvh;
      object-fit: contain;
    }

    #csvInput {
      margin: 10px 0;
      white-space: pre-line;
      font-size: 13px;
      line-height: 1.4;
    }

    #statsBox {
      margin-bottom: 10px;
      font-size: 14px;
      background: #f8f8f8;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 6px;
    }

    .dark #statsBox {
      background: #333;
      border-color: #666;
      color: #ddd;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>
      ホロライブカード一覧
      <div class="top-nav">
        <button onclick="location.href='holoca_skill_page.html'">🗂 カード詳細検索</button>
      </div>
    </h2>

    <div class="top-controls">
      <button onclick="toggleDarkMode()">🌗 モード切替</button>
      <input type="text" id="nameSearch" placeholder="カード名検索" oninput="renderTable()" />
      <button onclick="toggleFilters()">🔽 フィルター表示／非表示</button>
    </div>

    <div id="statsBox">
      <div id="countDisplay">所持枚数: --</div>
      <div id="typeDisplay">所持種類数: -- / --</div>
    </div>

    <div id="filtersWrapper" style="display: none;">
      <!-- 🎯 フィルター群が入る位置（レア・色・Bloom・商品など） -->
    </div>

    <div id="csvInput">
      <!-- 📥 CSVインポート欄（貼り付け対応） -->
    </div>

    <table id="cardTable">
      <thead>
        <tr>
          <th>画像</th>
          <th>名前／番号／カードタイプ</th>
          <th>レア</th>
          <th>色</th>
          <th>Bloom</th>
          <th>HP</th>
          <th>収録</th>
          <th>枚数</th>
          <th>skills</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div id="imageModal" onclick="hideImageModal()">
      <img src="" alt="拡大表示" />
    </div>
    <script>
      let cards = [];
    
      function toggleFilters() {
        const wrapper = document.getElementById("filtersWrapper");
        wrapper.style.display = wrapper.style.display === "none" ? "block" : "none";
      }
    
      function toggleDarkMode() {
        document.body.classList.toggle("dark");
        localStorage.setItem("darkMode", document.body.classList.contains("dark"));
      }
    
      function showImageModal(src) {
        const modal = document.getElementById("imageModal");
        modal.querySelector("img").src = src;
        modal.style.display = "block";
      }
    
      function hideImageModal() {
        document.getElementById("imageModal").style.display = "none";
      }
    
      function renderSkills(skills) {
        return skills.map(skill => {
          if (skill.text) {
            return `<b>【${skill.type}】</b><br>${skill.text}`;
          } else {
            const name = skill.name ?? "";
            const desc = skill.description ?? "";
            return `<b>【${skill.type}】</b><br>${name}<br>${desc}`;
          }
        }).join("<br><br>");
      }
      function renderTable() {
    const keyword = document.getElementById("nameSearch").value.toLowerCase();
    const tbody = document.querySelector("#cardTable tbody");
    tbody.innerHTML = "";

    let shown = 0, ownedTypes = 0, ownedTotal = 0;

    const filtered = cards.filter(card => {
      if (keyword && !card.name.toLowerCase().includes(keyword)) return false;

      // フィルター条件（後で実装される filterSet と照合）
      if (window.filterSet) {
        if (filterSet.rarity?.size && !filterSet.rarity.has(card.rarity)) return false;
        if (filterSet.color?.size && !filterSet.color.has(card.color)) return false;
        if (filterSet.bloom?.size && !filterSet.bloom.has(card.bloom)) return false;
        if (filterSet.product?.size && !filterSet.product.has(card.product)) return false;
      }

      return true;
    });

    filtered.forEach(card => {
      shown++;
      if (card.owned > 0) ownedTypes++;
      ownedTotal += card.owned;

      const row = document.createElement("tr");
      row.innerHTML = `
        <td><img src="${card.image}" alt="${card.name}" onclick="showImageModal('${card.image}')"></td>
        <td class="name-cell">
          <div style="font-weight: bold;">${card.name}</div>
          <div class="meta">📄 ${card.id}<br>🃏 ${card.card_type}</div>
        </td>
        <td>${card.rarity}</td>
        <td>${card.color}</td>
        <td>${card.bloom}</td>
        <td>${card.hp ?? "-"}</td>
        <td>${card.product}</td>
        <td><input type="number" value="${card.owned}" min="0"
          onchange="updateOwned('${card.id}', this.value)" /></td>
        <td>${renderSkills(card.skills)}</td>
      `;
      tbody.appendChild(row);
    });

    document.getElementById("countDisplay").textContent = `所持枚数: ${ownedTotal}`;
    document.getElementById("typeDisplay").textContent = `所持種類数: ${ownedTypes} / ${shown}`;
  }

  function updateOwned(id, value) {
    const num = Math.max(0, parseInt(value) || 0);
    localStorage.setItem("count_" + id, num);
    const card = cards.find(c => c.id === id);
    if (card) card.owned = num;
    renderTable();
  }
  async function loadData() {
    try {
      const res = await fetch("json_file/card_data.json");
      const raw = await res.json();
      cards = Object.entries(raw).map(([id, c]) => ({
        id,
        name: c.name,
        rarity: c.rarity ?? "-",
        color: c.color ?? "-",
        bloom: c.bloom_level ?? "-",
        hp: c.hp ?? c.life ?? "-",
        product: c.product ?? "-",
        image: c.image_url,
        card_type: c.card_type ?? "-",
        skills: c.skills ?? [],
        owned: parseInt(localStorage.getItem("count_" + id) ?? "0")
      }));
      buildFilters();
      renderTable();
    } catch (err) {
      alert("データ読み込みに失敗しました");
      console.error(err);
    }
  }

  function buildFilters() {
    const raritySet = new Set(cards.map(c => c.rarity));
    const colorSet = new Set(cards.map(c => c.color));
    const bloomSet = new Set(cards.map(c => c.bloom));
    const productSet = new Set(cards.map(c => c.product));

    const wrapper = document.getElementById("filtersWrapper");
    wrapper.innerHTML = "";

    window.filterSet = { rarity: new Set(), color: new Set(), bloom: new Set(), product: new Set() };

    const makeGroup = (label, values, key) => {
      const fieldset = document.createElement("fieldset");
      fieldset.className = "filter-group";
      const legend = document.createElement("legend");
      legend.textContent = label;
      fieldset.appendChild(legend);

      const row = document.createElement("div");
      row.className = "filter-row";

      Array.from(values).sort().forEach(val => {
        const input = document.createElement("input");
        input.type = "checkbox";
        input.id = `${key}_${val}`;
        input.onchange = () => {
          if (input.checked) filterSet[key].add(val);
          else filterSet[key].delete(val);
          renderTable();
        };

        const labelEl = document.createElement("label");
        labelEl.appendChild(input);
        labelEl.appendChild(document.createTextNode(val));
        row.appendChild(labelEl);
      });

      fieldset.appendChild(row);
      wrapper.appendChild(fieldset);
    };

    makeGroup("レアリティ", raritySet, "rarity");
    makeGroup("色", colorSet, "color");
    makeGroup("Bloom", bloomSet, "bloom");
    makeGroup("収録商品", productSet, "product");
  }

  window.onload = () => {
    if (localStorage.getItem("darkMode") === "true") {
      document.body.classList.add("dark");
    }
    loadData();
  };
  // 📥 CSVインポート欄からのデータ取り込み
  const csvInput = document.getElementById("csvInput");
  csvInput.textContent = `貼り付け対応: HL-001,2 のようにカード番号と枚数をカンマ区切りで入力`;

  csvInput.contentEditable = true;
  csvInput.oninput = () => {
    const lines = csvInput.textContent.trim().split(/[\r\n]+/);
    let updated = 0;
    lines.forEach(line => {
      const [id, count] = line.split(",").map(s => s.trim());
      if (!id || isNaN(parseInt(count))) return;
      localStorage.setItem("count_" + id, parseInt(count));
      const card = cards.find(c => c.id === id);
      if (card) {
        card.owned = parseInt(count);
        updated++;
      }
    });
    if (updated > 0) {
      renderTable();
    }
  };
</script>
</body>
</html>
