<!DOCTYPE html>
<html lang="ja">
<!-- Version: 4.1.0-COLLECTION-BINDER - Visual collection binder interface -->
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>ホロライブカード コレクションバインダー</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
      transition: background 0.3s, color 0.3s;
      overflow-x: hidden;
    }

    .dark { 
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
      color: #eee; 
    }

    /* ヘッダー - コンパクト化 */
    .header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 10px 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 1000;
      border-bottom: 2px solid rgba(102, 126, 234, 0.3);
    }

    .dark .header {
      background: rgba(44, 62, 80, 0.95);
      border-bottom-color: rgba(52, 152, 219, 0.3);
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1400px;
      margin: 0 auto;
    }

    .header h1 {
      margin: 0;
      background: linear-gradient(45deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 1.8em;
      font-weight: bold;
    }

    /* コンパクトコントロール */
    .compact-controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .compact-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 20px;
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      font-size: 0.8em;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .compact-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .compact-btn.active {
      background: linear-gradient(45deg, #28a745, #20c997);
    }

    /* バインダーメイン領域 */
    .binder-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* バインダーページスタイル */
    .binder-page {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
    }

    .dark .binder-page {
      background: rgba(52, 73, 94, 0.95);
      border-color: rgba(255,255,255,0.1);
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 2px solid rgba(102, 126, 234, 0.2);
      padding-bottom: 10px;
    }

    .page-title {
      font-size: 1.2em;
      font-weight: bold;
      color: #667eea;
    }

    .dark .page-title {
      color: #3498db;
    }

    .page-info {
      font-size: 0.9em;
      color: #666;
      display: flex;
      gap: 15px;
    }

    .dark .page-info {
      color: #bdc3c7;
    }

    /* バインダーグリッド - 3x3の9枚配置 */
    .binder-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin: 20px 0;
    }

    /* カードスロット */
    .card-slot {
      aspect-ratio: 63/88;
      border: 3px dashed rgba(102, 126, 234, 0.3);
      border-radius: 12px;
      position: relative;
      transition: all 0.3s ease;
      background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(0,0,0,0.05));
      cursor: pointer;
      overflow: hidden;
    }

    .card-slot:hover {
      border-color: rgba(102, 126, 234, 0.8);
      transform: scale(1.02);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
    }

    .card-slot.occupied {
      border: 3px solid rgba(40, 167, 69, 0.8);
      background: linear-gradient(145deg, rgba(40, 167, 69, 0.1), rgba(40, 167, 69, 0.05));
    }

    .card-slot.reserved {
      border: 3px solid rgba(255, 193, 7, 0.8);
      background: linear-gradient(145deg, rgba(255, 193, 7, 0.1), rgba(255, 193, 7, 0.05));
    }

    /* カード画像 */
    .card-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 8px;
      transition: transform 0.3s ease;
    }

    .card-slot:hover .card-image {
      transform: scale(1.05);
    }

    /* カード情報オーバーレイ */
    .card-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, rgba(0,0,0,0.8));
      color: white;
      padding: 8px;
      transform: translateY(100%);
      transition: transform 0.3s ease;
    }

    .card-slot:hover .card-overlay {
      transform: translateY(0);
    }

    .card-name {
      font-size: 0.8em;
      font-weight: bold;
      margin-bottom: 2px;
    }

    .card-rarity {
      font-size: 0.7em;
      opacity: 0.9;
    }

    /* 空きスロットの表示 */
    .empty-slot-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: rgba(102, 126, 234, 0.5);
      font-size: 0.8em;
      text-align: center;
      padding: 10px;
    }

    .slot-number {
      font-size: 2em;
      margin-bottom: 5px;
      opacity: 0.3;
    }

    .slot-action {
      font-size: 0.7em;
      opacity: 0.6;
    }

    /* 自動配置モード */
    .auto-arrange-panel {
      background: rgba(102, 126, 234, 0.1);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid rgba(102, 126, 234, 0.3);
    }

    .auto-arrange-title {
      font-weight: bold;
      margin-bottom: 10px;
      color: #667eea;
    }

    .dark .auto-arrange-title {
      color: #3498db;
    }

    .arrange-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
    }

    .arrange-option {
      background: rgba(255, 255, 255, 0.8);
      border: 2px solid transparent;
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }

    .dark .arrange-option {
      background: rgba(52, 73, 94, 0.8);
    }

    .arrange-option:hover {
      border-color: rgba(102, 126, 234, 0.5);
      transform: translateY(-2px);
    }

    .arrange-option.selected {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.2);
    }

    .option-title {
      font-weight: bold;
      margin-bottom: 5px;
    }

    .option-desc {
      font-size: 0.8em;
      color: #666;
    }

    .dark .option-desc {
      color: #bdc3c7;
    }

    /* コレクション統計 */
    .collection-stats {
      display: flex;
      gap: 15px;
      align-items: center;
      justify-content: center;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    .stat-item {
      background: rgba(255, 255, 255, 0.9);
      padding: 10px 15px;
      border-radius: 20px;
      font-size: 0.9em;
      font-weight: bold;
      color: #667eea;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .dark .stat-item {
      background: rgba(52, 73, 94, 0.9);
      color: #3498db;
    }

    /* レスポンシブ対応 - スマホファースト */
    @media (max-width: 768px) {
      .header {
        padding: 8px 15px;
      }
      
      .header-content {
        flex-direction: column;
        gap: 8px;
      }
      
      .header h1 {
        font-size: 1.4em;
      }
      
      .binder-container {
        padding: 15px 10px;
      }
      
      .binder-page {
        padding: 20px 15px;
        margin-bottom: 20px;
      }
      
      /* スマホ用 - 2x2グリッドに変更 */
      .binder-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin: 15px 0;
      }
      
      /* カードスロットのタッチ操作改善 */
      .card-slot {
        min-height: 120px;
        border-width: 2px;
        touch-action: manipulation;
      }
      
      .empty-slot-content {
        padding: 8px;
      }
      
      .slot-number {
        font-size: 1.5em;
      }
      
      .slot-action {
        font-size: 0.8em;
      }
      
      /* タッチ用ボタンサイズ */
      .compact-controls {
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
      }
      
      .compact-btn {
        padding: 12px 16px;
        font-size: 0.9em;
        min-width: 44px;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      /* 自動配置パネル */
      .arrange-options {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .arrange-option {
        padding: 16px;
        font-size: 1em;
      }
      
      /* 統計表示 */
      .collection-stats {
        flex-direction: column;
        gap: 10px;
        margin: 15px 0;
      }
      
      .stat-item {
        padding: 12px 20px;
        font-size: 1em;
        width: 100%;
        text-align: center;
        box-sizing: border-box;
      }
      
      /* ページ情報 */
      .page-info {
        flex-direction: column;
        gap: 5px;
        text-align: right;
      }
      
      /* カードオーバーレイ */
      .card-overlay {
        position: static;
        background: rgba(0,0,0,0.8);
        transform: none;
        border-radius: 0 0 8px 8px;
        padding: 6px;
      }
      
      .card-name {
        font-size: 0.7em;
      }
      
      .card-rarity {
        font-size: 0.6em;
      }
    }

    /* 極小画面対応 */
    @media (max-width: 480px) {
      .binder-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .card-slot {
        max-width: 280px;
        margin: 0 auto;
      }
      
      .header h1 {
        font-size: 1.2em;
      }
      
      .compact-btn {
        padding: 10px 14px;
        font-size: 0.85em;
      }
    }

    /* タブレット対応 */
    @media (min-width: 769px) and (max-width: 1200px) {
      .binder-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 18px;
      }
    }

    /* スワイプジェスチャー用スタイル */
    .swipe-indicator {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.8em;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
      z-index: 1001;
    }

    .swipe-indicator.show {
      opacity: 1;
    }

    /* モバイル用フローティングボタン */
    .mobile-fab {
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(45deg, #667eea, #764ba2);
      border: none;
      color: white;
      font-size: 1.2em;
      box-shadow: 0 4px 16px rgba(0,0,0,0.3);
      cursor: pointer;
      z-index: 1000;
      transition: all 0.3s ease;
      display: none;
    }

    .mobile-fab:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
    }

    @media (max-width: 768px) {
      .mobile-fab {
        display: flex;
        align-items: center;
        justify-content: center;
      }
    }

    /* アニメーション */
    @keyframes cardAppear {
      from {
        opacity: 0;
        transform: scale(0.8) rotateY(90deg);
      }
      to {
        opacity: 1;
        transform: scale(1) rotateY(0deg);
      }
    }

    .card-slot.new-card {
      animation: cardAppear 0.6s ease-out;
    }

    /* ドラッグ&ドロップ */
    .card-slot.drag-over {
      border-color: #28a745;
      background: rgba(40, 167, 69, 0.2);
      transform: scale(1.05);
    }

    .card-slot.dragging {
      opacity: 0.5;
      transform: rotate(5deg);
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <h1>🎴 コレクションバインダー</h1>
      <div class="compact-controls">
        <button class="compact-btn" onclick="toggleTheme()" title="ダークモード切替">🌙</button>
        <button class="compact-btn" onclick="showAutoArrangePanel()" title="自動配置">📋</button>
        <button class="compact-btn" onclick="toggleManualMode()" title="手動配置" id="manualModeBtn">✋</button>
        <button class="compact-btn" onclick="saveBinderLayout()" title="レイアウト保存">💾</button>
        <button class="compact-btn" onclick="goHome()" title="ホームに戻る">🏠</button>
      </div>
    </div>
  </div>

  <div class="binder-container">
    <!-- 自動配置パネル -->
    <div class="auto-arrange-panel" id="autoArrangePanel" style="display: none;">
      <div class="auto-arrange-title">📋 自動配置オプション</div>
      <div class="arrange-options">
        <div class="arrange-option" onclick="autoArrange('rarity')">
          <div class="option-title">レアリティ順</div>
          <div class="option-desc">RRR → RR → R → C の順で配置</div>
        </div>
        <div class="arrange-option" onclick="autoArrange('series')">
          <div class="option-title">シリーズ順</div>
          <div class="option-desc">同じシリーズでグループ化</div>
        </div>
        <div class="arrange-option" onclick="autoArrange('color')">
          <div class="option-title">カラー順</div>
          <div class="option-desc">色ごとにまとめて配置</div>
        </div>
        <div class="arrange-option" onclick="autoArrange('collection')">
          <div class="option-title">コレクション率順</div>
          <div class="option-desc">所持済み → 未所持の順</div>
        </div>
        <div class="arrange-option" onclick="autoArrange('release')">
          <div class="option-title">発売日順</div>
          <div class="option-desc">新しいシリーズから古い順</div>
        </div>
        <div class="arrange-option" onclick="autoArrange('custom')">
          <div class="option-title">カスタム配置</div>
          <div class="option-desc">お気に入りカードを優先</div>
        </div>
      </div>
    </div>

    <!-- コレクション統計 -->
    <div class="collection-stats">
      <div class="stat-item" id="totalOwnedStat">所持: 0枚</div>
      <div class="stat-item" id="collectionRateStat">所持率: 0%</div>
      <div class="stat-item" id="currentPageStat">ページ: 1</div>
      <div class="stat-item" id="filledSlotsStat">配置済み: 0/9</div>
    </div>

    <!-- バインダーページコンテナ -->
    <div id="binderPages"></div>

    <!-- ページナビゲーション -->
    <div class="collection-stats">
      <button class="compact-btn" onclick="previousPage()" id="prevPageBtn">◀ 前のページ</button>
      <button class="compact-btn" onclick="nextPage()" id="nextPageBtn">次のページ ▶</button>
      <button class="compact-btn" onclick="addNewPage()">➕ ページ追加</button>
    </div>
  </div>

  <!-- モバイル用フローティングボタン -->
  <button class="mobile-fab" onclick="toggleMobileMenu()" id="mobileFab">⚙️</button>

  <!-- スワイプインジケーター -->
  <div class="swipe-indicator" id="swipeIndicator"></div>

  <script>
    // バインダーの状態管理
    let binderState = {
      binderId: null,
      binderData: null,
      currentPage: 0,
      pages: [],
      totalCards: 0,
      ownedCards: 0,
      manualMode: false,
      autoArrangeVisible: false
    };

    let cardsData = [];
    let userCollection = {};
    let binderCollection = { binders: [] };
    
    // モバイル用の変数
    let touchStartX = 0;
    let touchStartY = 0;
    let isMobile = window.innerWidth <= 768;
    let mobileMenuVisible = false;

    // 初期化
    document.addEventListener('DOMContentLoaded', function() {
      // URLパラメータからバインダーIDを取得
      const urlParams = new URLSearchParams(window.location.search);
      binderState.binderId = urlParams.get('binderId');
      
      if (!binderState.binderId) {
        alert('バインダーが指定されていません');
        window.location.href = 'binder_collection.html';
        return;
      }

      loadCardData();
      loadUserCollection();
      loadBinderCollection();
      initializeBinder();
      updateStats();
      initializeMobileFeatures();
    });

    // カードデータの読み込み
    async function loadCardData() {
      try {
        const response = await fetch('./json_file/card_data.json');
        cardsData = await response.json();
        binderState.totalCards = cardsData.length;
      } catch (error) {
        console.error('Failed to load card data:', error);
      }
    }

    // ユーザーコレクションの読み込み
    function loadUserCollection() {
      const saved = localStorage.getItem('userCollection');
      userCollection = saved ? JSON.parse(saved) : {};
      
      // 所持カード数を計算
      binderState.ownedCards = Object.values(userCollection).reduce((count, quantity) => {
        return count + (quantity > 0 ? 1 : 0);
      }, 0);
    }

    // バインダーコレクションの読み込み
    function loadBinderCollection() {
      const saved = localStorage.getItem('binderCollection');
      if (saved) {
        binderCollection = JSON.parse(saved);
      }
      
      // 指定されたバインダーを取得
      binderState.binderData = binderCollection.binders.find(b => b.id == binderState.binderId);
      if (!binderState.binderData) {
        alert('指定されたバインダーが見つかりません');
        window.location.href = 'binder_collection.html';
        return;
      }
      
      // バインダーのページデータを復元
      if (binderState.binderData.pages) {
        binderState.pages = binderState.binderData.pages;
      } else {
        binderState.pages = [createEmptyPage()];
        binderState.binderData.pages = binderState.pages;
      }
      
      // ヘッダータイトルを更新
      updateBinderTitle();
    }

    // バインダーの初期化
    function initializeBinder() {
      // バインダーデータが既に読み込まれているので、直接レンダリング
      renderBinder();
    }

    // バインダータイトルの更新
    function updateBinderTitle() {
      const headerTitle = document.querySelector('.header h1');
      if (binderState.binderData && headerTitle) {
        headerTitle.innerHTML = `🎴 ${binderState.binderData.name}`;
      }
    }

    // 空のページを作成
    function createEmptyPage() {
      return {
        id: Date.now(),
        name: `ページ ${binderState.pages.length + 1}`,
        slots: Array(9).fill(null) // 3x3の9スロット
      };
    }

    // バインダーのレンダリング
    function renderBinder() {
      const container = document.getElementById('binderPages');
      container.innerHTML = '';

      if (binderState.pages.length === 0) {
        binderState.pages = [createEmptyPage()];
      }

      const currentPageData = binderState.pages[binderState.currentPage];
      if (!currentPageData) {
        binderState.currentPage = 0;
        return renderBinder();
      }

      // ページの作成
      const pageDiv = document.createElement('div');
      pageDiv.className = 'binder-page';
      pageDiv.innerHTML = `
        <div class="page-header">
          <div class="page-title">${currentPageData.name}</div>
          <div class="page-info">
            <span>ページ ${binderState.currentPage + 1} / ${binderState.pages.length}</span>
            <span>配置済み: ${currentPageData.slots.filter(slot => slot !== null).length}/9</span>
          </div>
        </div>
        <div class="binder-grid" id="currentPageGrid"></div>
      `;

      container.appendChild(pageDiv);
      renderPageSlots(currentPageData.slots);
      updateStats();
    }

    // ページスロットのレンダリング
    function renderPageSlots(slots) {
      const grid = document.getElementById('currentPageGrid');
      grid.innerHTML = '';

      slots.forEach((slotData, index) => {
        const slot = document.createElement('div');
        slot.className = 'card-slot';
        slot.setAttribute('data-slot-index', index);
        
        if (slotData) {
          // カードが配置されている場合
          slot.classList.add('occupied');
          const card = cardsData.find(c => c.id === slotData.cardId);
          if (card) {
            slot.innerHTML = `
              <img src="${card.cardImageURL || './images/placeholder.png'}" 
                   alt="${card.name}" 
                   class="card-image"
                   onerror="this.src='./images/placeholder.png'">
              <div class="card-overlay">
                <div class="card-name">${card.name}</div>
                <div class="card-rarity">${card.rarity || 'Unknown'}</div>
              </div>
            `;
          }
        } else {
          // 空のスロット
          slot.innerHTML = `
            <div class="empty-slot-content">
              <div class="slot-number">${index + 1}</div>
              <div class="slot-action">クリックしてカードを配置</div>
            </div>
          `;
        }

        // イベントリスナーの追加
        slot.addEventListener('click', () => openCardSelector(index));
        slot.addEventListener('dragover', handleDragOver);
        slot.addEventListener('drop', (e) => handleDrop(e, index));
        
        grid.appendChild(slot);
      });
    }

    // カード選択モーダルを開く
    function openCardSelector(slotIndex) {
      if (!binderState.manualMode) {
        if (isMobile) {
          showMobileAlert('手動配置モードを有効にしてください', '⚠️');
        } else {
          alert('手動配置モードを有効にしてください');
        }
        return;
      }

      // 所持カードのみを表示するモーダルを作成
      const ownedCards = cardsData.filter(card => userCollection[card.id] > 0);
      
      if (ownedCards.length === 0) {
        if (isMobile) {
          showMobileAlert('配置可能なカードがありません', '📋');
        } else {
          alert('配置可能なカードがありません');
        }
        return;
      }

      if (isMobile) {
        // モバイル用のカード選択UI
        showMobileCardSelector(slotIndex, ownedCards);
      } else {
        // デスクトップ用の簡易選択
        const cardNames = ownedCards.map(card => `${card.name} (${card.rarity})`);
        const selectedIndex = prompt(`配置するカードを選択してください:\n${cardNames.map((name, i) => `${i}: ${name}`).join('\n')}\n\n番号を入力:`);
        
        if (selectedIndex !== null && selectedIndex !== '') {
          const index = parseInt(selectedIndex);
          if (index >= 0 && index < ownedCards.length) {
            placeCardInSlot(slotIndex, ownedCards[index].id);
          }
        }
      }
    }

    // スロットにカードを配置
    function placeCardInSlot(slotIndex, cardId) {
      const currentPage = binderState.pages[binderState.currentPage];
      currentPage.slots[slotIndex] = { cardId, placedAt: Date.now() };
      
      saveBinder();
      renderBinder();
    }

    // 自動配置
    function autoArrange(mode) {
      const ownedCards = cardsData.filter(card => userCollection[card.id] > 0);
      
      if (ownedCards.length === 0) {
        alert('配置可能なカードがありません');
        return;
      }

      // ソート方法を選択
      let sortedCards = [...ownedCards];
      switch(mode) {
        case 'rarity':
          sortedCards.sort((a, b) => {
            const rarityOrder = { 'RRR': 0, 'RR': 1, 'R': 2, 'C': 3 };
            return (rarityOrder[a.rarity] || 4) - (rarityOrder[b.rarity] || 4);
          });
          break;
        case 'series':
          sortedCards.sort((a, b) => (a.expansion || '').localeCompare(b.expansion || ''));
          break;
        case 'color':
          sortedCards.sort((a, b) => (a.cardColor || '').localeCompare(b.cardColor || ''));
          break;
        case 'collection':
          sortedCards.sort((a, b) => (userCollection[b.id] || 0) - (userCollection[a.id] || 0));
          break;
        case 'release':
          sortedCards.sort((a, b) => new Date(b.releaseDate || 0) - new Date(a.releaseDate || 0));
          break;
        case 'custom':
          // お気に入り機能があれば使用（今回は名前順でフォールバック）
          sortedCards.sort((a, b) => a.name.localeCompare(b.name));
          break;
      }

      // 必要なページ数を計算
      const requiredPages = Math.ceil(sortedCards.length / 9);
      
      // ページを追加/調整
      while (binderState.pages.length < requiredPages) {
        binderState.pages.push(createEmptyPage());
      }

      // カードを配置
      let cardIndex = 0;
      for (let pageIndex = 0; pageIndex < requiredPages && cardIndex < sortedCards.length; pageIndex++) {
        const page = binderState.pages[pageIndex];
        page.slots = Array(9).fill(null);
        
        for (let slotIndex = 0; slotIndex < 9 && cardIndex < sortedCards.length; slotIndex++) {
          page.slots[slotIndex] = {
            cardId: sortedCards[cardIndex].id,
            placedAt: Date.now(),
            autoArranged: true
          };
          cardIndex++;
        }
      }

      binderState.currentPage = 0;
      saveBinder();
      renderBinder();
      hideAutoArrangePanel();
      
      alert(`${mode}順で${sortedCards.length}枚のカードを配置しました！`);
    }

    // 統計の更新
    function updateStats() {
      document.getElementById('totalOwnedStat').textContent = `所持: ${binderState.ownedCards}枚`;
      
      const collectionRate = binderState.totalCards > 0 ? 
        Math.round((binderState.ownedCards / binderState.totalCards) * 100) : 0;
      document.getElementById('collectionRateStat').textContent = `所持率: ${collectionRate}%`;
      
      document.getElementById('currentPageStat').textContent = 
        `ページ: ${binderState.currentPage + 1}/${binderState.pages.length}`;
      
      const currentPage = binderState.pages[binderState.currentPage];
      const filledSlots = currentPage ? currentPage.slots.filter(slot => slot !== null).length : 0;
      document.getElementById('filledSlotsStat').textContent = `配置済み: ${filledSlots}/9`;
    }

    // ユーティリティ関数
    function toggleTheme() {
      document.body.classList.toggle('dark');
      localStorage.setItem('darkMode', document.body.classList.contains('dark'));
    }

    function showAutoArrangePanel() {
      const panel = document.getElementById('autoArrangePanel');
      panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
      binderState.autoArrangeVisible = panel.style.display === 'block';
    }

    function hideAutoArrangePanel() {
      document.getElementById('autoArrangePanel').style.display = 'none';
      binderState.autoArrangeVisible = false;
    }

    function toggleManualMode() {
      binderState.manualMode = !binderState.manualMode;
      const btn = document.getElementById('manualModeBtn');
      if (binderState.manualMode) {
        btn.classList.add('active');
        btn.textContent = '✋';
        btn.title = '手動配置モード ON';
      } else {
        btn.classList.remove('active');
        btn.textContent = '✋';
        btn.title = '手動配置モード OFF';
      }
    }

    function previousPage() {
      if (binderState.currentPage > 0) {
        binderState.currentPage--;
        renderBinder();
      }
    }

    function nextPage() {
      if (binderState.currentPage < binderState.pages.length - 1) {
        binderState.currentPage++;
        renderBinder();
      }
    }

    function addNewPage() {
      binderState.pages.push(createEmptyPage());
      binderState.currentPage = binderState.pages.length - 1;
      saveBinder();
      renderBinder();
    }

    function saveBinder() {
      if (binderState.binderData) {
        // バインダーデータを更新
        binderState.binderData.pages = binderState.pages;
        binderState.binderData.pageCount = binderState.pages.length;
        binderState.binderData.cardCount = binderState.pages.reduce((count, page) => {
          return count + page.slots.filter(slot => slot !== null).length;
        }, 0);
        binderState.binderData.updatedAt = new Date().toISOString();
        
        // バインダーコレクション全体を保存
        localStorage.setItem('binderCollection', JSON.stringify(binderCollection));
      }
    }

    function saveBinderLayout() {
      saveBinder();
      alert('バインダーレイアウトを保存しました！');
    }

    function goHome() {
      // バインダー一覧に戻る
      window.location.href = 'binder_collection.html';
    }

    // ドラッグ&ドロップの処理
    function handleDragOver(e) {
      e.preventDefault();
      e.currentTarget.classList.add('drag-over');
    }

    function handleDrop(e, slotIndex) {
      e.preventDefault();
      e.currentTarget.classList.remove('drag-over');
      // ドラッグ&ドロップの実装は今後の拡張で対応
    }

    // ダークモードの復元
    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark');
    }

    // モバイル用機能の初期化
    function initializeMobileFeatures() {
      isMobile = window.innerWidth <= 768;
      
      // スワイプジェスチャーの設定
      const binderContainer = document.querySelector('.binder-container');
      if (binderContainer && isMobile) {
        binderContainer.addEventListener('touchstart', handleTouchStart, { passive: false });
        binderContainer.addEventListener('touchend', handleTouchEnd, { passive: false });
      }
      
      // リサイズイベント
      window.addEventListener('resize', () => {
        isMobile = window.innerWidth <= 768;
      });
    }

    // タッチ開始
    function handleTouchStart(e) {
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
    }

    // タッチ終了（スワイプ検出）
    function handleTouchEnd(e) {
      if (!touchStartX || !touchStartY) return;
      
      const touchEndX = e.changedTouches[0].clientX;
      const touchEndY = e.changedTouches[0].clientY;
      
      const diffX = touchStartX - touchEndX;
      const diffY = touchStartY - touchEndY;
      
      // 水平スワイプの検出（縦のスクロールを妨げないように）
      if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
        if (diffX > 0) {
          // 左スワイプ - 次のページ
          nextPage();
          showSwipeIndicator('次のページ →');
        } else {
          // 右スワイプ - 前のページ
          previousPage();
          showSwipeIndicator('← 前のページ');
        }
      }
      
      touchStartX = 0;
      touchStartY = 0;
    }

    // スワイプインジケーター表示
    function showSwipeIndicator(message) {
      const indicator = document.getElementById('swipeIndicator');
      indicator.textContent = message;
      indicator.classList.add('show');
      setTimeout(() => {
        indicator.classList.remove('show');
      }, 1500);
    }

    // モバイル用アラート
    function showMobileAlert(message, icon = '📱') {
      const alertDiv = document.createElement('div');
      alertDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.9);
        color: white;
        padding: 20px 30px;
        border-radius: 15px;
        z-index: 10000;
        text-align: center;
        font-size: 1.1em;
        max-width: 80vw;
        box-shadow: 0 8px 32px rgba(0,0,0,0.5);
      `;
      alertDiv.innerHTML = `<div style="font-size: 1.5em; margin-bottom: 10px;">${icon}</div>${message}`;
      
      document.body.appendChild(alertDiv);
      
      setTimeout(() => {
        alertDiv.remove();
      }, 2500);
    }

    // モバイル用カードセレクター
    function showMobileCardSelector(slotIndex, ownedCards) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 10000;
        overflow-y: auto;
        padding: 20px;
        box-sizing: border-box;
      `;
      
      const content = document.createElement('div');
      content.style.cssText = `
        background: white;
        border-radius: 15px;
        padding: 20px;
        max-width: 500px;
        margin: 0 auto;
        color: #333;
      `;
      
      content.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 style="margin: 0;">カードを選択</h3>
          <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 1.5em; cursor: pointer;">✕</button>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; max-height: 60vh; overflow-y: auto;">
          ${ownedCards.map((card, index) => `
            <div onclick="selectCard(${slotIndex}, '${card.id}'); this.closest('.modal').remove();" 
                 style="border: 2px solid #ddd; border-radius: 8px; padding: 8px; cursor: pointer; text-align: center; font-size: 0.8em;">
              <img src="${card.cardImageURL || './images/placeholder.png'}" 
                   style="width: 100%; height: 60px; object-fit: cover; border-radius: 4px; margin-bottom: 5px;"
                   onerror="this.src='./images/placeholder.png'">
              <div style="font-weight: bold; line-height: 1.2;">${card.name}</div>
              <div style="color: #666; font-size: 0.9em;">${card.rarity || 'Unknown'}</div>
            </div>
          `).join('')}
        </div>
      `;
      
      modal.className = 'modal';
      modal.appendChild(content);
      document.body.appendChild(modal);
    }

    // カード選択（モバイル用）
    function selectCard(slotIndex, cardId) {
      placeCardInSlot(slotIndex, cardId);
      showMobileAlert('カードを配置しました！', '✅');
    }

    // モバイル用メニュー切り替え
    function toggleMobileMenu() {
      mobileMenuVisible = !mobileMenuVisible;
      const fab = document.getElementById('mobileFab');
      
      if (mobileMenuVisible) {
        fab.textContent = '✕';
        fab.style.background = 'linear-gradient(45deg, #dc3545, #c82333)';
        showAutoArrangePanel();
      } else {
        fab.textContent = '⚙️';
        fab.style.background = 'linear-gradient(45deg, #667eea, #764ba2)';
        hideAutoArrangePanel();
      }
    }
  </script>
</body>
</html>
