<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ホロライブカード管理</title>
  <style>
    body { font-family: sans-serif; margin: 1em; transition: background 0.3s, color 0.3s; }
    table { border-collapse: collapse; width: 100%; margin-top: 1em; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; font-size: 0.95em; }
    select, input[type="text"], button { margin: 0.5em 0.5em 0.5em 0; }
    img { width: 60px; border-radius: 4px; }
    tr[data-rarity="OSR"] { background-color: #ffe5f0; }
    tr[data-rarity="RR"]  { background-color: #e6f5ff; }
    tr[data-rarity="R"]   { background-color: #f9fff0; }
    tr[data-rarity="U"]   { background-color: #f3f3f3; }
    tr[data-rarity="C"]   { background-color: #fff; }
    .dark { background-color: #222; color: #eee; }
    .dark table, .dark th, .dark td { border-color: #666; }
    .dark input, .dark select, .dark button { background-color: #333; color: #eee; }
    .dark #cardTable th {background-color: #eee;}
    .dark #cardTable td, .dark #cardTable th { color: #111; } /* JSON表示部分だけ黒に固定 */
  </style>
</head>
<body>
  <h2>ホロライブカード一覧（所持枚数対応）</h2>
  <button onclick="toggleDarkMode()">🌗 ダークモード切替</button>
  <br>
  <input type="text" id="nameSearch" placeholder="カード名検索" oninput="renderTable()">
  <label>レアリティ:</label>
  <select id="rarityFilter" onchange="renderTable()">
    <option value="">すべて</option>
    <option value="OSR">OSR</option>
    <option value="RR">RR</option>
    <option value="R">R</option>
    <option value="U">U</option>
    <option value="C">C</option>
  </select>
  <label>Bloom:</label>
  <select id="bloomFilter" onchange="renderTable()">
    <option value="">すべて</option>
    <option value="Debut">Debut</option>
    <option value="1st">1st</option>
    <option value="2nd">2nd</option>
    <option value="-">-</option>
  </select>
  <label>収録商品:</label>
  <select id="productFilter" onchange="renderTable()">
    <option value="">すべて</option>
  </select>
  <label><input type="checkbox" id="ownedFilter" onchange="renderTable()"> 所持ありのみ表示</label>
  <div id="countDisplay" style="margin-top:1em; font-weight:bold;"></div>

  <table id="cardTable">
    <thead>
      <tr>
        <th>画像</th><th>カード名</th><th>レア</th><th>Bloom</th><th>種別</th><th>HP</th><th>収録</th><th>所持枚数</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let cards = [];

    function setupProductFilter() {
      const products = [...new Set(cards.map(c => c.product))].sort();
      const select = document.getElementById("productFilter");
      select.innerHTML = '<option value="">すべて</option>';
      products.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p;
        opt.textContent = p;
        select.appendChild(opt);
      });
    }

    function renderTable() {
      const keyword = document.getElementById("nameSearch").value.toLowerCase();
      const rarity = document.getElementById("rarityFilter").value;
      const bloom = document.getElementById("bloomFilter").value;
      const product = document.getElementById("productFilter").value;
      const ownedOnly = document.getElementById("ownedFilter").checked;

      const tbody = document.querySelector("#cardTable tbody");
      tbody.innerHTML = "";
      let shown = 0;
      let ownedCount = 0;

      cards.forEach(card => {
        const count = card.owned;
        if (keyword && !card.name.toLowerCase().includes(keyword)) return;
        if (rarity && card.rarity !== rarity) return;
        if (bloom && card.bloom !== bloom) return;
        if (product && card.product !== product) return;
        if (ownedOnly && (!count || count === 0)) return;

        shown++;
        ownedCount += parseInt(count || 0);

        const row = document.createElement("tr");
        row.setAttribute("data-rarity", card.rarity);
        row.innerHTML = `
          <td><a href="${card.url}" target="_blank"><img src="${card.image}" alt="${card.name}"></a></td>
          <td>${card.name}</td>
          <td>${card.rarity}</td>
          <td>${card.bloom}</td>
          <td>${card.type}</td>
          <td>${card.hp}</td>
          <td>${card.product}</td>
          <td><input type="number" min="0" value="${count}" onchange="updateOwned('${card.id}', this.value)" style="width:50px;"></td>
        `;
        tbody.appendChild(row);
      });

      updateCountDisplay(shown, ownedCount);
    }

    function updateOwned(id, value) {
      const num = Math.max(0, parseInt(value) || 0);
      localStorage.setItem("count_" + id, JSON.stringify(num));
      const card = cards.find(c => c.id === id);
      if (card) card.owned = num;
      renderTable();
    }

    function updateCountDisplay(totalCards, ownedCards) {
      const percent = totalCards > 0 ? Math.round((ownedCards / totalCards) * 100) : 0;
      document.getElementById("countDisplay").textContent = `所持枚数：${ownedCards} / 表示カード数：${totalCards}（平均 ${percent}%）`;
    }

    function toggleDarkMode() {
      document.body.classList.toggle("dark");
      localStorage.setItem("darkMode", document.body.classList.contains("dark"));
    }

    window.onload = () => {
      if (localStorage.getItem("darkMode") === "true") {
        document.body.classList.add("dark");
      }

      fetch("json_file/card_data.json")
        .then(response => response.json())
        .then(rawData => {
          cards = Object.entries(rawData).map(([key, card]) => ({
            id: key,
            name: card.name,
            rarity: card.rarity,
            bloom: card.bloom_level ?? "-",
            type: card.card_type,
            hp: card.card_type === "ホロメン" ? card.hp : "-",
            product: card.product,
            image: card.image_url,
            url: `https://hololive-official-cardgame.com/cardlist/?id=${card.id}`,
            owned: parseInt(localStorage.getItem("count_" + card.id) ?? "0")
          }));
          setupProductFilter();
          renderTable();
        })
        .catch(() => alert("JSONファイルの読み込みに失敗しました"));
    };
  </script>
</body>
</html>
