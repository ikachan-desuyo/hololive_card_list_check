<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>サポートカードシステム テスト</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f0f0f0;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    .card-example {
      background: #f9f9f9;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      border-left: 4px solid #007bff;
    }
    .success {
      border-left-color: #28a745;
      background-color: #d4edda;
    }
    .error {
      border-left-color: #dc3545;
      background-color: #f8d7da;
    }
    .warning {
      border-left-color: #ffc107;
      background-color: #fff3cd;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background-color: #007bff;
      color: white;
    }
    button:hover {
      background-color: #0056b3;
    }
    .log-area {
      background: #000;
      color: #00ff00;
      padding: 15px;
      border-radius: 5px;
      font-family: monospace;
      height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🎴 サポートカードシステム動作テスト</h1>
    
    <div class="test-section">
      <h2>📋 テスト概要</h2>
      <p>このページは、ホロライブTCGバトルシミュレーターのサポートカード（ファン・ツール・マスコット）装備システムの動作をテストします。</p>
    </div>

    <div class="test-section">
      <h2>🔧 テスト項目</h2>
      <button onclick="testCardEffectUtils()">CardEffectUtils読み込みテスト</button>
      <button onclick="testAttachSupportCard()">サポートカード装備テスト</button>
      <button onclick="testEquipmentRules()">装備ルールテスト</button>
      <button onclick="testSpecialCards()">特殊カードテスト（雪民・こよりの助手くん）</button>
      <button onclick="clearLog()">ログクリア</button>
    </div>

    <div class="test-section">
      <h2>📊 テスト結果</h2>
      <div id="logArea" class="log-area">
テスト開始準備完了...
ボタンをクリックしてテストを開始してください。
      </div>
    </div>

    <div class="test-section">
      <h2>📝 実装状況</h2>
      <div class="card-example warning">
        <strong>⚠️ 現在の問題:</strong><br>
        • HandManagerのuseSupportCardメソッドでTODOコメントのみ<br>
        • 実際の装備処理が呼び出されていない<br>
        • UIでの装備表示が未実装
      </div>
      <div class="card-example success">
        <strong>✅ 実装済み:</strong><br>
        • CardEffectUtilsにattachSupportCardメソッド<br>
        • ファン・ツール・マスコットの装備制限ロジック<br>
        • 特殊カード（雪民、こよりの助手くん）の制限
      </div>
    </div>
  </div>

  <!-- 必要なスクリプトファイルを読み込み -->
  <script src="js/utils.js"></script>
  <script src="battle_simulator/card-effects/card-effect-utils.js"></script>

  <script>
    // ログ出力関数
    function log(message, type = 'info') {
      const logArea = document.getElementById('logArea');
      const timestamp = new Date().toLocaleTimeString();
      const prefix = type === 'error' ? '❌' : type === 'success' ? '✅' : type === 'warning' ? '⚠️' : 'ℹ️';
      
      logArea.textContent += `[${timestamp}] ${prefix} ${message}\n`;
      logArea.scrollTop = logArea.scrollHeight;
    }

    function clearLog() {
      document.getElementById('logArea').textContent = 'ログをクリアしました...\n';
    }

    // モックBattleEngineクラス（テスト用）
    class MockBattleEngine {
      constructor() {
        this.players = {
          1: {
            hand: [],
            center: null,
            collab: null,
            back1: null,
            back2: null,
            back3: null,
            back4: null,
            back5: null
          }
        };
      }
    }

    // テスト用のモックデータ
    const mockCards = {
      fan: {
        id: 'test-fan-001',
        name: 'テストファン',
        card_type: 'サポート・ファン',
        image_url: 'test.jpg'
      },
      tool: {
        id: 'test-tool-001', 
        name: 'テストツール',
        card_type: 'サポート・ツール',
        image_url: 'test.jpg'
      },
      mascot: {
        id: 'test-mascot-001',
        name: 'テストマスコット', 
        card_type: 'サポート・マスコット',
        image_url: 'test.jpg'
      },
      yukimin: {
        id: 'hBP04-106',
        name: '雪民',
        card_type: 'サポート・ファン',
        image_url: 'test.jpg'
      },
      koyori_assistant: {
        id: 'hBP04-105',
        name: 'こよりの助手くん',
        card_type: 'サポート・ファン',
        image_url: 'test.jpg'
      },
      holomem_lamy: {
        id: 'test-lamy',
        name: '雪花ラミィ',
        card_type: 'ホロメン',
        image_url: 'test.jpg',
        equipment: { fans: [], mascots: [], tools: [] }
      },
      holomem_koyori: {
        id: 'test-koyori',
        name: '博衣こより',
        card_type: 'ホロメン', 
        image_url: 'test.jpg',
        equipment: { fans: [], mascots: [], tools: [] }
      },
      holomem_other: {
        id: 'test-other',
        name: 'テストホロメン',
        card_type: 'ホロメン',
        image_url: 'test.jpg',
        equipment: { fans: [], mascots: [], tools: [] }
      }
    };

    // CardEffectUtils読み込みテスト
    function testCardEffectUtils() {
      log('=== CardEffectUtils読み込みテスト開始 ===');
      
      try {
        if (typeof CardEffectUtils === 'undefined') {
          log('CardEffectUtilsクラスが読み込まれていません', 'error');
          return;
        }
        
        const mockEngine = new MockBattleEngine();
        const utils = new CardEffectUtils(mockEngine);
        
        if (typeof utils.attachSupportCard === 'function') {
          log('CardEffectUtils正常に読み込まれました', 'success');
          log('attachSupportCardメソッドが利用可能です', 'success');
        } else {
          log('attachSupportCardメソッドが見つかりません', 'error');
        }
      } catch (error) {
        log(`CardEffectUtils初期化エラー: ${error.message}`, 'error');
      }
    }

    // サポートカード装備テスト
    function testAttachSupportCard() {
      log('=== サポートカード装備テスト開始 ===');
      
      try {
        const mockEngine = new MockBattleEngine();
        const utils = new CardEffectUtils(mockEngine);
        
        // ファンカード装備テスト
        log('ファンカード装備テスト...');
        const fanResult = utils.attachSupportCard(1, mockCards.holomem_other, mockCards.fan);
        log(`ファン装備結果: ${fanResult.success ? 'SUCCESS' : 'FAILED - ' + fanResult.reason}`, 
            fanResult.success ? 'success' : 'error');
        
        // ツールカード装備テスト
        log('ツールカード装備テスト...');
        const toolResult = utils.attachSupportCard(1, mockCards.holomem_other, mockCards.tool);
        log(`ツール装備結果: ${toolResult.success ? 'SUCCESS' : 'FAILED - ' + toolResult.reason}`, 
            toolResult.success ? 'success' : 'error');
        
        // マスコットカード装備テスト
        log('マスコットカード装備テスト...');
        const mascotResult = utils.attachSupportCard(1, mockCards.holomem_other, mockCards.mascot);
        log(`マスコット装備結果: ${mascotResult.success ? 'SUCCESS' : 'FAILED - ' + mascotResult.reason}`, 
            mascotResult.success ? 'success' : 'error');
        
      } catch (error) {
        log(`装備テストエラー: ${error.message}`, 'error');
      }
    }

    // 装備ルールテスト（制限チェック）
    function testEquipmentRules() {
      log('=== 装備ルールテスト開始 ===');
      
      try {
        const mockEngine = new MockBattleEngine();
        const utils = new CardEffectUtils(mockEngine);
        const testHolomem = JSON.parse(JSON.stringify(mockCards.holomem_other));
        
        // 1. ツール重複装備テスト
        log('ツール重複装備制限テスト...');
        const tool1Result = utils.attachSupportCard(1, testHolomem, mockCards.tool);
        log(`1回目のツール装備: ${tool1Result.success ? 'SUCCESS' : 'FAILED'}`, 
            tool1Result.success ? 'success' : 'error');
        
        const tool2Result = utils.attachSupportCard(1, testHolomem, {
          ...mockCards.tool,
          id: 'test-tool-002',
          name: 'テストツール2'
        });
        log(`2回目のツール装備: ${tool2Result.success ? 'FAILED (正常)' : 'SUCCESS (異常)'}`, 
            !tool2Result.success ? 'success' : 'error');
        log(`制限理由: ${tool2Result.reason || 'なし'}`);
        
        // 2. マスコット重複装備テスト
        log('マスコット重複装備制限テスト...');
        const testHolomem2 = JSON.parse(JSON.stringify(mockCards.holomem_other));
        const mascot1Result = utils.attachSupportCard(1, testHolomem2, mockCards.mascot);
        const mascot2Result = utils.attachSupportCard(1, testHolomem2, {
          ...mockCards.mascot,
          id: 'test-mascot-002',
          name: 'テストマスコット2'
        });
        log(`マスコット重複装備は制限されました: ${!mascot2Result.success ? 'OK' : 'NG'}`, 
            !mascot2Result.success ? 'success' : 'error');
        
      } catch (error) {
        log(`装備ルールテストエラー: ${error.message}`, 'error');
      }
    }

    // 特殊カードテスト
    function testSpecialCards() {
      log('=== 特殊カードテスト開始 ===');
      
      try {
        const mockEngine = new MockBattleEngine();
        const utils = new CardEffectUtils(mockEngine);
        
        // 雪民テスト
        log('雪民装備テスト...');
        
        // 雪花ラミィに装備（成功するべき）
        const lamyResult = utils.attachSupportCard(1, mockCards.holomem_lamy, mockCards.yukimin);
        log(`雪民 → 雪花ラミィ: ${lamyResult.success ? 'SUCCESS' : 'FAILED - ' + lamyResult.reason}`, 
            lamyResult.success ? 'success' : 'error');
        
        // 他のホロメンに装備（失敗するべき）
        const otherResult = utils.attachSupportCard(1, mockCards.holomem_other, mockCards.yukimin);
        log(`雪民 → 他ホロメン: ${!otherResult.success ? 'REJECTED (正常)' : 'ACCEPTED (異常)'}`, 
            !otherResult.success ? 'success' : 'error');
        log(`制限理由: ${otherResult.reason || 'なし'}`);
        
        // こよりの助手くんテスト
        log('こよりの助手くん装備テスト...');
        
        // 博衣こよりに装備（成功するべき）
        const koyoriResult = utils.attachSupportCard(1, mockCards.holomem_koyori, mockCards.koyori_assistant);
        log(`こよりの助手くん → 博衣こより: ${koyoriResult.success ? 'SUCCESS' : 'FAILED - ' + koyoriResult.reason}`, 
            koyoriResult.success ? 'success' : 'error');
        
      } catch (error) {
        log(`特殊カードテストエラー: ${error.message}`, 'error');
      }
    }

    // ページ読み込み時の初期化
    window.addEventListener('load', function() {
      log('テストページ読み込み完了');
      log('利用可能なテスト項目:');
      log('• CardEffectUtils読み込みテスト');
      log('• サポートカード装備テスト'); 
      log('• 装備ルールテスト');
      log('• 特殊カードテスト');
      log('');
      log('ボタンをクリックしてテストを開始してください。');
    });
  </script>
</body>
</html>
